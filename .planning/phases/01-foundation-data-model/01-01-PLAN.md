---
phase: 01-foundation-data-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/next.config.mjs
  - backend/next-env.d.ts
  - backend/src/payload.config.ts
  - backend/src/payload-types.ts
  - backend/src/app/(payload)/admin/[[...segments]]/page.tsx
  - backend/src/app/(payload)/admin/[[...segments]]/not-found.tsx
  - backend/src/app/(payload)/admin/importMap.js
  - backend/src/app/(payload)/layout.tsx
  - backend/src/app/(payload)/custom.scss
  - backend/src/app/(frontend)/layout.tsx
  - backend/src/app/(frontend)/page.tsx
  - backend/src/app/layout.tsx
  - backend/src/collections/Users.ts
  - backend/src/collections/Media.ts
  - backend/src/access/isAdmin.ts
  - backend/src/access/isAdminOrSelf.ts
  - backend/src/access/organizerScoped.ts
autonomous: true

must_haves:
  truths:
    - "Payload CMS dev server starts without errors on port 3000"
    - "Payload admin UI is accessible at /admin"
    - "Users collection has role field with admin and organizer options"
    - "Admin-only user creation (no self-registration) enforced via access control"
    - "PostgreSQL database connection works via DATABASE_URI env var"
  artifacts:
    - path: "backend/package.json"
      provides: "Project dependencies and scripts"
      contains: "payload"
    - path: "backend/src/payload.config.ts"
      provides: "Main Payload CMS configuration"
      contains: "buildConfig"
    - path: "backend/src/collections/Users.ts"
      provides: "Users collection with auth and roles"
      contains: "role"
    - path: "backend/src/access/organizerScoped.ts"
      provides: "Organizer-scoped access control"
      contains: "createdBy"
  key_links:
    - from: "backend/src/payload.config.ts"
      to: "backend/src/collections/Users.ts"
      via: "collections array import"
      pattern: "import.*Users"
    - from: "backend/src/payload.config.ts"
      to: "@payloadcms/db-postgres"
      via: "db adapter configuration"
      pattern: "postgresAdapter"
    - from: "backend/src/collections/Users.ts"
      to: "backend/src/access/isAdmin.ts"
      via: "access control function import"
      pattern: "import.*isAdmin"
---

<objective>
Initialize the Payload CMS 3.x backend project with Next.js 15 runtime, PostgreSQL connection, Users collection with Admin/Organizer roles, and reusable access control functions.

Purpose: Establish the backend foundation that all domain collections (Events, AttendanceDays, Sessions, etc.) will build upon. Without this, nothing else can be created or tested.
Output: Working Payload CMS instance with admin UI, auth-enabled Users collection, and access control utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-data-model/01-CONTEXT.md
@.planning/phases/01-foundation-data-model/01-RESEARCH.md
@docker-compose.yml
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Payload CMS 3.x backend project with Next.js 15</name>
  <files>
    backend/package.json
    backend/tsconfig.json
    backend/next.config.mjs
    backend/next-env.d.ts
    backend/src/payload.config.ts
    backend/src/payload-types.ts
    backend/src/app/(payload)/admin/[[...segments]]/page.tsx
    backend/src/app/(payload)/admin/[[...segments]]/not-found.tsx
    backend/src/app/(payload)/admin/importMap.js
    backend/src/app/(payload)/layout.tsx
    backend/src/app/(payload)/custom.scss
    backend/src/app/(frontend)/layout.tsx
    backend/src/app/(frontend)/page.tsx
    backend/src/app/layout.tsx
  </files>
  <action>
    Create the Payload CMS 3.x project structure from scratch (do NOT use `npx create-payload-app` as we need precise control).

    **package.json:**
    - name: "c-sign-backend"
    - scripts: `dev` (next dev), `build` (next build), `start` (next start), `payload` (cross-env PAYLOAD_CONFIG_PATH=src/payload.config.ts payload), `generate:types` (payload generate:types)
    - dependencies: payload@latest, @payloadcms/next@latest, @payloadcms/db-postgres@latest, @payloadcms/richtext-lexical@latest, @payloadcms/ui@latest, next@15, react@19, react-dom@19, sharp, cross-env, zod, graphql (peer dep of Payload)
    - devDependencies: typescript, @types/node, @types/react, @types/react-dom, eslint

    **tsconfig.json:**
    - strict: true, jsx: "react-jsx", module: "esnext", moduleResolution: "bundler", target: "es2022"
    - paths: {"@/*": ["./src/*"]}
    - include: ["src/**/*", "next-env.d.ts"]

    **next.config.mjs:**
    - Import `withPayload` from `@payloadcms/next/withPayload` and wrap the Next.js config
    - Set `experimental.reactCompiler: false` (not needed)
    - Set `output: 'standalone'` for Docker deployment readiness

    **payload.config.ts:**
    - Import and use `buildConfig` from 'payload'
    - Use `postgresAdapter` from '@payloadcms/db-postgres' with `pool.connectionString` from `process.env.DATABASE_URI`
    - Use `lexicalEditor` from '@payloadcms/richtext-lexical'
    - Register Users and Media collections (other collections will be added in Plan 02)
    - Set `secret` from `process.env.PAYLOAD_SECRET`
    - Set `typescript.outputFile` to `src/payload-types.ts`
    - Set `admin.importMap.baseDir` to resolve path of current directory

    **Next.js App Router files:**
    - Create the standard Payload 3.x app router structure:
      - `src/app/layout.tsx` — root layout with html/body tags
      - `src/app/(payload)/layout.tsx` — Payload admin layout importing `@payloadcms/next/layouts`
      - `src/app/(payload)/admin/[[...segments]]/page.tsx` — admin catch-all page
      - `src/app/(payload)/admin/[[...segments]]/not-found.tsx` — admin 404
      - `src/app/(payload)/admin/importMap.js` — empty placeholder (auto-generated on build)
      - `src/app/(payload)/custom.scss` — empty custom styles placeholder
      - `src/app/(frontend)/layout.tsx` — simple pass-through layout for non-admin pages
      - `src/app/(frontend)/page.tsx` — minimal home page (just renders "c-sign API running")

    **IMPORTANT:** Do not import JSX components inside payload.config.ts (Payload v3 anti-pattern). Keep config and UI layers separate.

    Run `cd /workspace/backend && npm install` to install all dependencies.
    Run `cd /workspace/backend && npx payload generate:types` to generate initial types (may need the server running first; if it fails, skip — types will generate on first dev server start).
  </action>
  <verify>
    1. `ls /workspace/backend/package.json` exists
    2. `ls /workspace/backend/src/payload.config.ts` exists
    3. `ls /workspace/backend/src/app/(payload)/admin/\[\[...segments\]\]/page.tsx` exists
    4. `cd /workspace/backend && npx next build 2>&1 | tail -20` — builds without errors (or at minimum, `npm run dev` starts without immediate crash; build may require DB connection)
    5. Alternatively, verify TypeScript compilation: `cd /workspace/backend && npx tsc --noEmit 2>&1 | head -30`
  </verify>
  <done>
    Backend project has all required files. `npm install` completed successfully with all Payload CMS dependencies. TypeScript compilation passes or dev server starts without config errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Users collection with roles and access control functions</name>
  <files>
    backend/src/collections/Users.ts
    backend/src/collections/Media.ts
    backend/src/access/isAdmin.ts
    backend/src/access/isAdminOrSelf.ts
    backend/src/access/organizerScoped.ts
  </files>
  <action>
    **Users.ts** — Auth-enabled collection per locked decisions:
    - `slug: 'users'`
    - `auth: true` (enables Payload built-in email/password auth)
    - `admin.useAsTitle: 'email'`
    - Fields:
      - `role`: select, required, defaultValue 'organizer', options: [{label: 'Admin', value: 'admin'}, {label: 'Organisateur', value: 'organizer'}]. French labels per user decision (bilingual comes Phase 5).
      - `firstName`: text, required, label 'Prenom'
      - `lastName`: text, required, label 'Nom'
    - Access control:
      - `create`: isAdmin (only admins can create users — no self-registration per locked decision)
      - `read`: isAdminOrSelf (admins read all, users read own record)
      - `update`: isAdminOrSelf
      - `delete`: isAdmin
      - `admin`: function returning `user?.role === 'admin' || user?.role === 'organizer'` (both roles can access admin panel)
    - admin.defaultColumns: ['email', 'firstName', 'lastName', 'role']

    **Media.ts** — Upload collection for signature images (will be used in Phase 2 but the collection must exist now for payload.config):
    - `slug: 'media'`
    - `upload: { mimeTypes: ['image/png', 'image/jpeg', 'image/webp'], imageSizes: [{ name: 'thumbnail', width: 200, height: 100, fit: 'contain' }] }`
    - Fields: `alt` (text, optional)
    - Access: authenticated users can create/read, admins can update/delete

    **isAdmin.ts:**
    ```typescript
    import type { Access } from 'payload'
    export const isAdmin: Access = ({ req: { user } }) => {
      return user?.role === 'admin' || false
    }
    ```

    **isAdminOrSelf.ts:**
    ```typescript
    import type { Access } from 'payload'
    export const isAdminOrSelf: Access = ({ req: { user } }) => {
      if (user?.role === 'admin') return true
      if (user) return { id: { equals: user.id } }
      return false
    }
    ```

    **organizerScoped.ts:**
    ```typescript
    import type { Access } from 'payload'
    export const organizerScoped: Access = ({ req: { user } }) => {
      if (user?.role === 'admin') return true
      if (user) return { createdBy: { equals: user.id } }
      return false
    }
    ```

    After creating collections, update payload.config.ts to import Users and Media if not already done in Task 1.

    Start the dev server briefly to verify: `cd /workspace/backend && timeout 30 npm run dev 2>&1` — look for "Payload CMS initialized" or similar success message. The first start will run database migrations automatically.

    **CRITICAL:** The database must be accessible. The env var `DATABASE_URI=postgresql://payload:payload_secret@postgres:5432/payload_poc` is set via docker-compose. If running inside the dev container, PostgreSQL should be available at `postgres:5432`. If not in the container, the dev server start might fail on DB connection — that's expected and acceptable for this task. The key verification is that TypeScript compiles and config is valid.
  </action>
  <verify>
    1. `ls /workspace/backend/src/collections/Users.ts /workspace/backend/src/collections/Media.ts` — both exist
    2. `ls /workspace/backend/src/access/isAdmin.ts /workspace/backend/src/access/isAdminOrSelf.ts /workspace/backend/src/access/organizerScoped.ts` — all exist
    3. `cd /workspace/backend && npx tsc --noEmit 2>&1 | head -20` — no TypeScript errors related to these files
    4. `grep -c "role" /workspace/backend/src/collections/Users.ts` — confirms role field exists
    5. `grep "createdBy" /workspace/backend/src/access/organizerScoped.ts` — confirms scoping logic
  </verify>
  <done>
    Users collection supports email/password auth with Admin and Organizer roles. Access control enforces: only admins create users (no self-registration), organizers see only their own records. Media collection configured for signature image uploads with 200x100 thumbnail. Three reusable access control functions (isAdmin, isAdminOrSelf, organizerScoped) are exported and ready for use by domain collections in Plan 02.
  </done>
</task>

</tasks>

<verification>
1. All files exist in expected locations under backend/src/
2. TypeScript compiles without errors: `cd /workspace/backend && npx tsc --noEmit`
3. payload.config.ts imports Users and Media collections
4. Users collection has auth:true and role field with admin/organizer options
5. Access control functions correctly implement RBAC pattern
6. package.json contains all required Payload CMS dependencies
</verification>

<success_criteria>
- Backend project initialized with Payload CMS 3.x + Next.js 15 + PostgreSQL adapter
- Users collection with auth, Admin/Organizer roles, no self-registration
- Media collection configured for image uploads with thumbnail generation
- Three access control functions (isAdmin, isAdminOrSelf, organizerScoped) ready for reuse
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-model/01-01-SUMMARY.md`
</output>
