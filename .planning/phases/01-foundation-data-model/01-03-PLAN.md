---
phase: 01-foundation-data-model
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - backend/src/seed/index.ts
  - backend/src/seed/run.ts
  - backend/package.json
autonomous: false

must_haves:
  truths:
    - "Payload admin UI loads at localhost:3000/admin with login screen"
    - "Admin user can log in and see all collections in sidebar"
    - "Creating an Event with 2 dates auto-generates 2 AttendanceDay records"
    - "Organizer user can only see events they created"
    - "Participant form shows beneficiary type dropdown with 7 options"
    - "Selecting 'Autre' reveals the free text precision field"
    - "Signature record can reference a participant, session, and media image"
  artifacts:
    - path: "backend/src/seed/index.ts"
      provides: "Seed data function using Payload Local API"
      contains: "payload.create"
    - path: "backend/src/seed/run.ts"
      provides: "Standalone seed runner script"
      contains: "getPayload"
  key_links:
    - from: "backend/src/seed/index.ts"
      to: "backend/src/collections/Users.ts"
      via: "payload.create for users collection"
      pattern: "collection.*users"
    - from: "backend/src/seed/index.ts"
      to: "backend/src/collections/Events.ts"
      via: "payload.create for events collection"
      pattern: "collection.*events"
---

<objective>
Create seed data for development/testing and verify the complete Phase 1 data model works end-to-end through the Payload admin UI.

Purpose: Without seed data, every developer (and Claude in future phases) must manually create test records. Seed data proves the data model works correctly and provides a baseline for Phase 2 (public signing flow). The human verification confirms that Payload admin renders all collections correctly, the afterChange hook fires, and access control works.
Output: Seed script + verified working Payload CMS instance with all collections functional.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-data-model/01-CONTEXT.md
@.planning/phases/01-foundation-data-model/01-01-SUMMARY.md
@.planning/phases/01-foundation-data-model/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seed data script with admin user, organizer, test event, participants, and sessions</name>
  <files>
    backend/src/seed/index.ts
    backend/src/seed/run.ts
    backend/package.json
  </files>
  <action>
    **seed/index.ts** — Main seed function using Payload Local API:
    ```typescript
    import type { Payload } from 'payload'

    export const seed = async (payload: Payload): Promise<void> => { ... }
    ```

    Create the following test data in order:

    1. **Admin user:**
       - email: admin@ceva.com, password: admin123, role: admin
       - firstName: Admin, lastName: Ceva

    2. **Organizer user:**
       - email: isabelle.leroy@ceva.com, password: organizer123, role: organizer
       - firstName: Isabelle, lastName: Leroy

    3. **Second organizer (to test scoping):**
       - email: marc.dupont@ceva.com, password: organizer123, role: organizer
       - firstName: Marc, lastName: Dupont

    4. **Event 1 (created by Isabelle):** Use `overrideAccess: true` to bypass access control during seeding.
       - title: 'Formation Veterinaires - Q1 2026'
       - location: 'Libourne, France'
       - selectedDates: [{ date: '2026-03-15' }, { date: '2026-03-16' }, { date: '2026-03-18' }] (non-consecutive — tests the locked decision)
       - expenseType: 'hospitality_catering'
       - organizerName: 'Isabelle Leroy'
       - organizerEmail: 'isabelle.leroy@ceva.com'
       - createdBy: isabelle.id
       - NOTE: afterChange hook should auto-create 3 AttendanceDays

    5. **Event 2 (created by Marc, for scoping test):**
       - title: 'Reunion Pharmaciens - Bordeaux'
       - location: 'Bordeaux, France'
       - selectedDates: [{ date: '2026-04-10' }]
       - expenseType: 'hospitality_snack'
       - organizerName: 'Marc Dupont'
       - organizerEmail: 'marc.dupont@ceva.com'
       - createdBy: marc.id

    6. **Sessions for Event 1, Day 1 (March 15):**
       - After event creation, query AttendanceDays for Event 1. For the first day:
         - Session 1: { name: 'Conference matin', attendanceDay: day1.id }
         - Session 2: { name: 'Dejeuner', attendanceDay: day1.id }
         - Session 3: { name: 'Atelier apres-midi', attendanceDay: day1.id }
       - Update the AttendanceDay to link sessions in its `sessions` field

    7. **Participants (3 with different beneficiary types):**
       - { lastName: 'Martin', firstName: 'Sophie', email: 'sophie.martin@vet.fr', city: 'Lyon', professionalNumber: 'VET-12345', beneficiaryType: 'veterinaire' }
       - { lastName: 'Bernard', firstName: 'Pierre', email: 'pierre.bernard@pharma.fr', city: 'Paris', professionalNumber: 'PHA-67890', beneficiaryType: 'pharmacien' }
       - { lastName: 'Petit', firstName: 'Marie', email: 'marie.petit@free.fr', city: 'Toulouse', beneficiaryType: 'autre', beneficiaryTypeOther: 'Consultante' }

    Add a `console.log` after each step so seeding progress is visible.
    Wrap the entire function in try/catch with meaningful error messages.

    **seed/run.ts** — Standalone runner:
    ```typescript
    import { getPayload } from 'payload'
    import config from '@/payload.config'
    import { seed } from './index'

    const run = async () => {
      const payload = await getPayload({ config })
      await seed(payload)
      console.log('Seed complete!')
      process.exit(0)
    }

    run().catch((err) => {
      console.error('Seed failed:', err)
      process.exit(1)
    })
    ```

    **Update package.json:** Add script:
    ```json
    "seed": "cross-env PAYLOAD_CONFIG_PATH=src/payload.config.ts npx tsx src/seed/run.ts"
    ```

    Also install `tsx` as a devDependency if not present: `cd /workspace/backend && npm install -D tsx`

    Run the seed script: `cd /workspace/backend && npm run seed 2>&1`
    - If it fails due to existing data (duplicate email), that's OK for idempotency — add a check at the start of seed() to skip if admin@ceva.com already exists.
    - If it fails due to DB connection, ensure PostgreSQL is running.
  </action>
  <verify>
    1. `ls /workspace/backend/src/seed/index.ts /workspace/backend/src/seed/run.ts` — both exist
    2. `grep "admin@ceva.com" /workspace/backend/src/seed/index.ts` — admin user seed present
    3. `grep "selectedDates" /workspace/backend/src/seed/index.ts` — non-consecutive dates in seed
    4. `grep "beneficiaryTypeOther" /workspace/backend/src/seed/index.ts` — "Autre" with specification tested
    5. `grep "seed" /workspace/backend/package.json` — seed script registered
    6. `cd /workspace/backend && npm run seed 2>&1 | tail -10` — seed completes (or at minimum, script can be loaded without syntax errors)
  </verify>
  <done>
    Seed script creates: 1 admin + 2 organizers, 2 events (one with 3 non-consecutive days, one single-day), 3 sessions for first event day, and 3 participants with different beneficiary types including "Autre" with specification. Script is idempotent (checks for existing data before creating).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Payload admin UI and data model end-to-end</name>
  <files>none</files>
  <action>
    Human verification of the complete Phase 1 data model via the Payload admin UI.

    Complete Payload CMS backend has been built with:
    - 7 collections (Users, Events, AttendanceDays, Sessions, Participants, Signatures, Media)
    - Admin/Organizer role-based access control
    - afterChange hook auto-generating AttendanceDays from Event dates
    - Seed data with test users, events, sessions, and participants

    Start the backend if not running: `cd /workspace/backend && npm run dev`

    Verification steps:

    1. **Admin login:** Navigate to http://localhost:3000/admin. Log in with admin@ceva.com / admin123. Verify the admin panel loads and shows all 7 collections in the sidebar.

    2. **Users list:** Click Users. Verify 3 users exist (admin + 2 organizers). Verify role column shows admin/organizer.

    3. **Events list:** Click Events. Verify 2 events exist. Click "Formation Veterinaires - Q1 2026". Verify:
       - selectedDates shows 3 dates (March 15, 16, 18 — non-consecutive)
       - attendanceDays shows 3 linked records (read-only)
       - expenseType, location, organizerName fields are populated

    4. **AttendanceDays:** Navigate to Attendance Days collection. Verify 4 total records (3 for Event 1, 1 for Event 2). Click one from Event 1 to verify it links back to the event and has correct date.

    5. **Sessions:** Navigate to Sessions. Verify 3 sessions exist for Day 1 of Event 1 ("Conference matin", "Dejeuner", "Atelier apres-midi").

    6. **Participants:** Navigate to Participants. Verify 3 records. Click Marie Petit to verify:
       - beneficiaryType shows "Autre"
       - beneficiaryTypeOther field shows "Consultante"

    7. **Organizer scoping test:** Log out. Log in as isabelle.leroy@ceva.com / organizer123. Navigate to Events. Verify only Event 1 ("Formation Veterinaires") is visible (Event 2 by Marc should be hidden).

    8. **Auto-generation test:** While logged as admin, create a new test event with 2 dates. Save it. Verify 2 AttendanceDay records are auto-created and linked.
  </action>
  <verify>
    User performs the 8 verification steps above and reports results.
  </verify>
  <done>
    All 8 verification steps pass: admin UI works, collections render correctly, afterChange hook fires, organizer scoping works, beneficiary taxonomy displays properly with conditional field.
  </done>
</task>

</tasks>

<verification>
1. Seed script exists and runs successfully
2. Payload admin UI accessible at localhost:3000/admin
3. All 7 collections visible and functional in admin
4. afterChange hook creates AttendanceDays for new event dates
5. Organizer scoping hides other organizers' events
6. Beneficiary type "Autre" conditional field works correctly
7. Non-consecutive dates (March 15, 16, 18) are handled correctly
</verification>

<success_criteria>
- Seed data populates all collections with realistic test data
- Admin can log in and manage all collections
- Organizer sees only their own events
- Event date changes trigger AttendanceDay auto-generation
- All locked decisions verified working: beneficiary taxonomy, non-consecutive dates, session model, no orphan deletion
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-model/01-03-SUMMARY.md`
</output>
