---
phase: 03-event-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/collections/Events.ts
  - frontend/package.json
  - frontend/src/mocks/data.ts
  - frontend/src/mocks/handlers.ts
  - frontend/src/mocks/browser.ts
  - frontend/src/main.tsx
  - frontend/src/components/ui/table.tsx
  - frontend/src/components/ui/badge.tsx
  - frontend/src/components/ui/calendar.tsx
  - frontend/src/components/ui/popover.tsx
  - frontend/src/components/ui/command.tsx
  - frontend/src/components/ui/dropdown-menu.tsx
autonomous: true

must_haves:
  truths:
    - "Events collection has a status field with draft/open/finalized options"
    - "Events collection has a participants relationship field (hasMany to participants)"
    - "Status transitions are validated (finalized events cannot go back to draft)"
    - "Mock SIMV search returns realistic French veterinarian data filtered by name or registration number"
    - "MSW intercepts /api/simv/search requests in development mode only"
  artifacts:
    - path: "backend/src/collections/Events.ts"
      provides: "Status field and participants relationship"
      contains: "status"
    - path: "frontend/src/mocks/data.ts"
      provides: "Mock SIMV registry with 100 participants"
      min_lines: 20
    - path: "frontend/src/mocks/handlers.ts"
      provides: "MSW request handler for /api/simv/search"
      contains: "simv/search"
    - path: "frontend/src/mocks/browser.ts"
      provides: "MSW browser worker setup"
      contains: "setupWorker"
    - path: "frontend/src/components/ui/table.tsx"
      provides: "shadcn/ui Table component"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/mocks/browser.ts"
      via: "conditional import in dev mode"
      pattern: "import\\.meta\\.env\\.DEV"
    - from: "frontend/src/mocks/handlers.ts"
      to: "frontend/src/mocks/data.ts"
      via: "import mockParticipants"
      pattern: "mockParticipants"
---

<objective>
Add event status workflow field and participant pre-population support to backend, install all Phase 3 frontend dependencies, and set up mock SIMV registry with MSW.

Purpose: Lay the foundation for all Phase 3 plans -- backend schema updates enable status workflow and participant management, frontend dependencies enable rich UI components, and MSW mock enables participant search development without real SIMV API.

Output: Updated Events collection, installed frontend packages, shadcn/ui components (table, badge, calendar, popover, command, dropdown-menu), working MSW mock for SIMV search.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-event-management/03-RESEARCH.md
@backend/src/collections/Events.ts
@frontend/package.json
@frontend/src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status field and participants relationship to Events collection</name>
  <files>backend/src/collections/Events.ts</files>
  <action>
Modify the Events collection to add two new fields:

1. **status field** — Add to the "Informations generales" tab, after the existing fields:
   - name: 'status'
   - type: 'select'
   - required: true
   - defaultValue: 'draft'
   - options: draft (Brouillon), open (Ouvert), finalized (Finalise)
   - label: 'Statut'

2. **participants relationship** — Add to the "Relations" tab:
   - name: 'participants'
   - type: 'relationship'
   - relationTo: 'participants'
   - hasMany: true
   - label: 'Participants attendus'
   - admin.description: 'Participants pre-inscrits pour cet evenement'

3. **Status transition validation** — Add a beforeChange hook that prevents invalid transitions:
   - draft -> open: allowed
   - draft -> finalized: allowed (skip straight to finalized)
   - open -> finalized: allowed
   - open -> draft: NOT allowed (throw error: "Un evenement ouvert ne peut pas revenir en brouillon")
   - finalized -> draft: NOT allowed (throw error: "Un evenement finalise ne peut pas etre modifie")
   - finalized -> open: NOT allowed for now (Phase 6 will add reopen feature)

   Add this as a new beforeChange hook BEFORE the existing createdBy hook. Check: if operation is 'update', fetch the existing doc to compare old status vs new status. Only validate transitions when status actually changes.

Keep all existing fields, tabs, hooks, and access control unchanged.
  </action>
  <verify>
Run `cd /workspace/backend && npx tsc --noEmit` to verify TypeScript compiles.
Verify the status field exists with grep for 'status' in Events.ts.
Verify the participants relationship exists with grep for 'participants' in Events.ts.
  </verify>
  <done>
Events collection has status field (draft/open/finalized) with default 'draft', participants hasMany relationship, and status transition validation hook. Backend compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Phase 3 frontend dependencies, add shadcn/ui components, set up MSW mock SIMV registry</name>
  <files>
    frontend/package.json
    frontend/src/mocks/data.ts
    frontend/src/mocks/handlers.ts
    frontend/src/mocks/browser.ts
    frontend/src/main.tsx
    frontend/src/components/ui/table.tsx
    frontend/src/components/ui/badge.tsx
    frontend/src/components/ui/calendar.tsx
    frontend/src/components/ui/popover.tsx
    frontend/src/components/ui/command.tsx
    frontend/src/components/ui/dropdown-menu.tsx
  </files>
  <action>
**Step 1: Install dependencies**

```bash
cd /workspace/frontend

# Table management
npm install @tanstack/react-table

# Date handling
npm install date-fns

# Dev-only mocking
npm install -D msw @faker-js/faker
```

**Step 2: Add shadcn/ui components**

Run these one at a time (shadcn CLI can be flaky if parallelized):
```bash
cd /workspace/frontend
npx shadcn@latest add table --yes
npx shadcn@latest add badge --yes
npx shadcn@latest add calendar --yes
npx shadcn@latest add popover --yes
npx shadcn@latest add command --yes
npx shadcn@latest add dropdown-menu --yes
```

If shadcn CLI fails for any component, manually create the component file following shadcn/ui source code patterns. Check the shadcn registry at https://ui.shadcn.com/docs/components/radix/ for each component.

**Step 3: Create MSW mock SIMV registry**

Create `frontend/src/mocks/data.ts`:
- Import faker from @faker-js/faker
- Set faker locale to French: `faker.locale = 'fr'` or use `import { fakerFR as faker } from '@faker-js/faker'`
- Define beneficiaryTypes array matching backend: ['asv', 'autre', 'eleveur', 'etudiant', 'pharmacien', 'technicien', 'veterinaire']
- Generate 100 mock participants with: id (uuid), lastName, firstName, email, city (French cities), professionalNumber (8-digit string, 70% probability), beneficiaryType (random from array)
- Export as `mockParticipants`

Create `frontend/src/mocks/handlers.ts`:
- Import { http, HttpResponse } from 'msw'
- Import mockParticipants from './data'
- Create handler for GET /api/simv/search:
  - Read 'q' query param
  - Filter mockParticipants by: lastName, firstName, or professionalNumber containing query (case-insensitive)
  - Return max 10 results: `HttpResponse.json({ results: filtered.slice(0, 10) })`
- Export handlers array

Create `frontend/src/mocks/browser.ts`:
- Import { setupWorker } from 'msw/browser'
- Import handlers from './handlers'
- Export `worker = setupWorker(...handlers)`

**Step 4: Wire MSW into main.tsx**

Modify `frontend/src/main.tsx` to conditionally start MSW in development:
- Use dynamic import to avoid bundling MSW in production
- IMPORTANT: MSW worker.start() returns a Promise -- must await it before rendering React app
- Pattern:

```typescript
async function enableMocking() {
  if (!import.meta.env.DEV) return
  const { worker } = await import('./mocks/browser')
  return worker.start({ onUnhandledRequest: 'bypass' })
}

enableMocking().then(() => {
  createRoot(document.getElementById('root')!).render(
    <StrictMode>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </StrictMode>,
  )
})
```

Also need to run MSW init to generate the service worker file:
```bash
cd /workspace/frontend
npx msw init public/ --save
```

This creates `public/mockServiceWorker.js` which MSW needs at runtime.
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Run `cd /workspace/frontend && npx vite build` to verify production build succeeds (MSW should be tree-shaken out).
Verify shadcn components exist: `ls frontend/src/components/ui/table.tsx frontend/src/components/ui/badge.tsx frontend/src/components/ui/calendar.tsx`
Verify mock files exist: `ls frontend/src/mocks/data.ts frontend/src/mocks/handlers.ts frontend/src/mocks/browser.ts`
  </verify>
  <done>
All Phase 3 frontend dependencies installed. shadcn/ui table, badge, calendar, popover, command, and dropdown-menu components available. MSW mock SIMV registry returns filtered French participant data on GET /api/simv/search?q=... in development mode. Production build succeeds without MSW bundled.
  </done>
</task>

</tasks>

<verification>
- `cd /workspace/backend && npx tsc --noEmit` passes
- `cd /workspace/frontend && npx tsc --noEmit` passes
- `cd /workspace/frontend && npx vite build` succeeds
- Events.ts contains 'status' field with draft/open/finalized
- Events.ts contains 'participants' relationship to participants
- frontend/src/mocks/ directory has data.ts, handlers.ts, browser.ts
- frontend/src/components/ui/ has table.tsx, badge.tsx, calendar.tsx, popover.tsx, command.tsx, dropdown-menu.tsx
- main.tsx conditionally starts MSW worker in dev mode
</verification>

<success_criteria>
Backend Events collection has status workflow field (draft/open/finalized with transition validation) and participants pre-population relationship. Frontend has all new dependencies installed, 6 new shadcn/ui components ready, and MSW mock SIMV registry functional in development mode.
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-management/03-01-SUMMARY.md`
</output>
