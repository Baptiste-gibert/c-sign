---
phase: 03-event-management
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/pages/EventCreatePage.tsx
  - frontend/src/hooks/use-events.ts
  - frontend/src/components/EventForm.tsx
  - frontend/src/components/DateSelector.tsx
  - frontend/src/lib/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Organizer can create event with title, location, organizer name, organizer email, expense type, and at least one date"
    - "Organizer can select expense type from 6 predefined options"
    - "Organizer can pick multiple non-consecutive dates using calendar"
    - "Organizer sees list of their events on dashboard with title, date, status, and expense type"
    - "Organizer can navigate from dashboard to event creation and back"
    - "Newly created event appears in dashboard list without page refresh"
  artifacts:
    - path: "frontend/src/pages/EventCreatePage.tsx"
      provides: "Event creation page with full form"
      min_lines: 30
    - path: "frontend/src/pages/DashboardPage.tsx"
      provides: "Event list dashboard"
      min_lines: 40
    - path: "frontend/src/hooks/use-events.ts"
      provides: "TanStack Query hooks for event CRUD"
      exports: ["useEvents", "useCreateEvent", "useEvent"]
    - path: "frontend/src/components/EventForm.tsx"
      provides: "Event creation form with validation"
      min_lines: 50
    - path: "frontend/src/components/DateSelector.tsx"
      provides: "Multi-date calendar picker"
      min_lines: 30
    - path: "frontend/src/lib/schemas.ts"
      provides: "Updated Zod schemas including eventSchema"
      contains: "eventSchema"
  key_links:
    - from: "frontend/src/pages/EventCreatePage.tsx"
      to: "frontend/src/hooks/use-events.ts"
      via: "useCreateEvent mutation"
      pattern: "useCreateEvent"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/hooks/use-events.ts"
      via: "useEvents query"
      pattern: "useEvents"
    - from: "frontend/src/hooks/use-events.ts"
      to: "/api/events"
      via: "fetch with credentials"
      pattern: "api/events"
    - from: "frontend/src/components/EventForm.tsx"
      to: "frontend/src/components/DateSelector.tsx"
      via: "DateSelector rendered inside form"
      pattern: "DateSelector"
---

<objective>
Build the event creation form and event list dashboard pages, enabling organizers to create events with full metadata and view their existing events.

Purpose: Implements EVNT-01 (create event), EVNT-03 (expense type selection), and EVNT-07 (event history/list). This is the core organizer workflow -- creating and viewing events.

Output: Working EventCreatePage with validated form, DashboardPage with event list table, TanStack Query hooks for event CRUD, DateSelector component for multi-date selection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-event-management/03-RESEARCH.md
@.planning/phases/03-event-management/03-01-SUMMARY.md
@.planning/phases/03-event-management/03-02-SUMMARY.md
@backend/src/collections/Events.ts
@frontend/src/lib/schemas.ts
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create event CRUD hooks, Zod schema, DateSelector component, and EventForm</name>
  <files>
    frontend/src/hooks/use-events.ts
    frontend/src/lib/schemas.ts
    frontend/src/components/DateSelector.tsx
    frontend/src/components/EventForm.tsx
  </files>
  <action>
**Create `frontend/src/hooks/use-events.ts`:**

TanStack Query hooks for event operations. ALL fetch calls MUST use `credentials: 'include'`.

- `useEvents()`: useQuery, queryKey ['events'], fetches GET /api/events?sort=-createdAt&depth=0. Returns data.docs (Payload wraps in { docs, totalDocs, ... }). Type the response properly.
- `useCreateEvent()`: useMutation, POSTs to /api/events with JSON body. On success: invalidateQueries(['events']), return created event. Accept onSuccess callback for navigation.
- `useEvent(id: string)`: useQuery, queryKey ['events', id], fetches GET /api/events/{id}?depth=1 (depth=1 to populate attendanceDays). enabled: !!id.
- `useUpdateEvent(id: string)`: useMutation, PATCHes to /api/events/{id}. On success: invalidateQueries(['events']) AND invalidateQueries(['events', id]).

Define TypeScript interfaces:
```typescript
interface PayloadEvent {
  id: string
  title: string
  location: string
  organizerName: string
  organizerEmail: string
  expenseType: string
  status: 'draft' | 'open' | 'finalized'
  selectedDates: Array<{ id: string; date: string }>
  attendanceDays?: Array<{ id: string; date: string }>
  participants?: Array<{ id: string; lastName: string; firstName: string }>
  createdBy: string | { id: string }
  createdAt: string
  updatedAt: string
}
```

**Update `frontend/src/lib/schemas.ts`:**

Add eventSchema (keep existing participantSchema untouched):

```typescript
export const eventSchema = z.object({
  title: z.string().min(1, "Le titre est requis").max(200, "Le titre est trop long"),
  location: z.string().min(1, "Le lieu est requis"),
  organizerName: z.string().min(1, "Le nom de l'organisateur est requis"),
  organizerEmail: z.string().email("Email invalide"),
  expenseType: z.enum([
    'hospitality_snack',
    'hospitality_catering',
    'hospitality_accommodation',
    'event_registration',
    'meeting_organization',
    'transport',
  ], { required_error: "Le type de depense est requis" }),
  selectedDates: z.array(
    z.object({ date: z.string() })
  ).min(1, "Au moins une date est requise"),
})

export type EventFormData = z.infer<typeof eventSchema>
```

**Create `frontend/src/components/DateSelector.tsx`:**

Multi-date picker using shadcn/ui Calendar + React Hook Form useFieldArray.

- Use useFormContext() to access form control (component is rendered inside FormProvider)
- useFieldArray with name 'selectedDates'
- Render shadcn/ui Calendar in mode="single" with French locale (import { fr } from 'date-fns/locale')
- On date select: check if date already in fields (compare by toDateString), if not append({ date: date.toISOString() })
- Show selected dates below calendar as chips/badges with date formatted using date-fns format(date, 'PPP', { locale: fr })
- Each chip has a remove button (X icon from lucide-react) calling remove(index)
- Use field.id as key (NOT index) -- critical for useFieldArray
- Show validation error from formState.errors.selectedDates if present
- Pass selected dates to Calendar as highlighted dates (modifiers or selected prop)
- Empty state: "Cliquez sur le calendrier pour selectionner des dates"

PITFALL AVOIDANCE:
- Use field.id as key, NOT index
- Append objects ({ date: value }), NOT primitives
- Do NOT stack useFieldArray actions

**Create `frontend/src/components/EventForm.tsx`:**

Complete event creation form using React Hook Form + zodResolver + shadcn/ui components.

- Wrap in FormProvider (useForm with zodResolver(eventSchema))
- Default values: { selectedDates: [], expenseType: undefined }
- Fields layout in single column, max-w-2xl:
  1. Title — shadcn Input with Label "Titre de l'evenement"
  2. Location — shadcn Input with Label "Lieu"
  3. Organizer name — shadcn Input with Label "Nom de l'organisateur"
     Pre-fill from auth user: `${user.firstName} ${user.lastName}` if available
  4. Organizer email — shadcn Input with Label "Email de l'organisateur"
     Pre-fill from auth user email if available
  5. Expense type — shadcn Select with Label "Type de depense"
     Options matching backend exactly:
     - Hospitalite - Collation (hospitality_snack)
     - Hospitalite - Restauration (hospitality_catering)
     - Hospitalite - Hebergement (hospitality_accommodation)
     - Frais d'inscription evenement (event_registration)
     - Frais de reunion/organisation (meeting_organization)
     - Frais de transport (transport)
  6. DateSelector component for date picking
  7. Submit button "Creer l'evenement" (loading state while submitting)

- Accept onSubmit prop: `(data: EventFormData) => void`
- Show field-level validation errors below each field in red text
- Accept optional isSubmitting prop to disable button

NOTE: The shadcn Select component needs special handling with React Hook Form. Use Controller from react-hook-form to wrap the Select, NOT register(). shadcn Select uses value/onValueChange pattern, not native HTML select.
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Verify eventSchema exists with grep for 'eventSchema' in schemas.ts.
Verify useEvents hook exists with grep for 'useEvents' in use-events.ts.
Verify DateSelector uses useFieldArray with grep for 'useFieldArray' in DateSelector.tsx.
Verify EventForm uses zodResolver with grep for 'zodResolver' in EventForm.tsx.
  </verify>
  <done>
Event CRUD hooks connect to Payload REST API with auth cookies. Zod eventSchema validates all required fields. DateSelector picks multiple dates with calendar. EventForm renders complete creation form with pre-filled organizer info and all 6 expense types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement DashboardPage and EventCreatePage with navigation</name>
  <files>
    frontend/src/pages/DashboardPage.tsx
    frontend/src/pages/EventCreatePage.tsx
  </files>
  <action>
**Replace stub `frontend/src/pages/DashboardPage.tsx`:**

Event list dashboard — the organizer's home page after login.

Structure:
- Header section: "Mes evenements" title + "Nouvel evenement" button (link to /events/new, use lucide-react Plus icon)
- Loading state: centered Loader2 spinner while events load
- Empty state: centered message "Aucun evenement" with "Creez votre premier evenement" call-to-action button linking to /events/new
- Event list: use shadcn/ui Table (NOT TanStack Table -- save that for participant table in Plan 04). Simple table is sufficient for event list.
  Columns:
  1. Titre — event title, clickable link to /events/{id}
  2. Lieu — location
  3. Dates — formatted date range or count ("3 jours" if multiple, formatted date if single)
  4. Type de depense — expense type label (map value to French label)
  5. Statut — status badge using shadcn Badge:
     - draft: variant="secondary", text "Brouillon"
     - open: variant="default" (blue/primary), text "Ouvert"
     - finalized: variant="outline", text "Finalise"
  6. Actions — "Voir" link to /events/{id}

- Use useEvents() hook for data
- Sort events by createdAt descending (most recent first -- handled by API query)
- Use date-fns format for date display, French locale
- Helper function to map expense type values to French labels (same labels as backend options)
- Use useNavigate for button navigation

**Replace stub `frontend/src/pages/EventCreatePage.tsx`:**

Event creation page wrapping EventForm.

Structure:
- Header: "Nouvel evenement" title with back button (arrow left to /dashboard)
- EventForm component rendered with onSubmit handler
- onSubmit: call createEvent mutation, on success navigate to /events/{newEvent.doc.id}
- Error handling: show toast or error message if creation fails
- Pass isSubmitting from mutation state to form

Import and use useCreateEvent from hooks. useNavigate for redirect after success.
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Run `cd /workspace/frontend && npx vite build` to verify production build succeeds.
Verify DashboardPage uses useEvents with grep for 'useEvents' in DashboardPage.tsx.
Verify DashboardPage has status badges with grep for 'Badge' in DashboardPage.tsx.
Verify EventCreatePage uses useCreateEvent with grep for 'useCreateEvent' in EventCreatePage.tsx.
Verify EventCreatePage navigates after creation with grep for 'navigate' in EventCreatePage.tsx.
  </verify>
  <done>
DashboardPage shows event list table with title, location, dates, expense type, and status badges. EventCreatePage provides full event creation form that submits to Payload API and redirects to event detail. Navigation between dashboard and creation works. Newly created events appear in list immediately via cache invalidation.
  </done>
</task>

</tasks>

<verification>
- `cd /workspace/frontend && npx tsc --noEmit` passes
- `cd /workspace/frontend && npx vite build` succeeds
- DashboardPage renders event list with all 5 columns + status badges
- EventCreatePage renders EventForm with all required fields
- DateSelector allows picking multiple dates from calendar
- Creating event via form calls POST /api/events with credentials
- After creation, redirect to event detail page
- Event list refreshes automatically after creation (cache invalidation)
- All expense type values match backend Events collection options exactly
- French labels throughout (Brouillon, Ouvert, Finalise, etc.)
</verification>

<success_criteria>
Organizer can navigate to /events/new, fill in event title, location, organizer info, select expense type, pick dates from calendar, and submit. New event is created in Payload CMS. Organizer sees their events listed on /dashboard with title, dates, expense type, and status badge. Navigation works bidirectionally between dashboard and event creation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-management/03-03-SUMMARY.md`
</output>
