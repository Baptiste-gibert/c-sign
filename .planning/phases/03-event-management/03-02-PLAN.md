---
phase: 03-event-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/hooks/use-auth.ts
  - frontend/src/components/ProtectedRoute.tsx
  - frontend/src/components/OrganizerLayout.tsx
  - frontend/src/pages/LoginPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Organizer can log in with email and password via frontend login form"
    - "Authenticated organizer is redirected to /dashboard after login"
    - "Unauthenticated user visiting /dashboard is redirected to /login"
    - "Organizer can log out and is redirected to /login"
    - "Protected routes show loading state while auth check is in progress"
  artifacts:
    - path: "frontend/src/hooks/use-auth.ts"
      provides: "Authentication hook with login, logout, user state"
      exports: ["useAuth"]
    - path: "frontend/src/components/ProtectedRoute.tsx"
      provides: "Route guard component"
      exports: ["ProtectedRoute"]
    - path: "frontend/src/components/OrganizerLayout.tsx"
      provides: "Shell layout with nav header and logout"
      exports: ["OrganizerLayout"]
    - path: "frontend/src/pages/LoginPage.tsx"
      provides: "Login form page"
      exports: ["LoginPage"]
    - path: "frontend/src/App.tsx"
      provides: "Updated routing with protected routes"
  key_links:
    - from: "frontend/src/hooks/use-auth.ts"
      to: "/api/users/me"
      via: "fetch with credentials: include"
      pattern: "credentials.*include"
    - from: "frontend/src/hooks/use-auth.ts"
      to: "/api/users/login"
      via: "POST fetch for login"
      pattern: "api/users/login"
    - from: "frontend/src/components/ProtectedRoute.tsx"
      to: "frontend/src/hooks/use-auth.ts"
      via: "useAuth hook call"
      pattern: "useAuth"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ProtectedRoute.tsx"
      via: "wrapping organizer routes"
      pattern: "ProtectedRoute"
---

<objective>
Implement organizer authentication flow with login page, protected route guards, and organizer shell layout.

Purpose: Gate all organizer features (event creation, participant management, attendance dashboard) behind authentication. This is the first authenticated frontend work in the project -- Phase 2 was entirely public/anonymous.

Output: Working login flow, protected route guard, organizer layout shell with navigation header, updated App.tsx routing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-event-management/03-RESEARCH.md
@frontend/src/App.tsx
@frontend/src/main.tsx
@backend/src/collections/Users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication hook, ProtectedRoute, and LoginPage</name>
  <files>
    frontend/src/hooks/use-auth.ts
    frontend/src/components/ProtectedRoute.tsx
    frontend/src/pages/LoginPage.tsx
  </files>
  <action>
**Create `frontend/src/hooks/use-auth.ts`:**

Authentication hook using TanStack Query for state management. Follow the pattern from research doc exactly:

- Define User interface: `{ id: string; email: string; role: 'admin' | 'organizer'; firstName: string; lastName: string }`
- `useAuth()` hook exports: user, isLoading, isAuthenticated, login, logout, loginError, isLoggingIn
- Auth check: `useQuery` with queryKey ['auth', 'me'], queryFn fetches GET /api/users/me with `credentials: 'include'`. On non-ok response, return null (not throw). staleTime: 5 minutes. retry: false.
- Login: `useMutation` POSTing to /api/users/login with JSON body {email, password}, `credentials: 'include'`. onSuccess: invalidate ['auth', 'me'] query.
- Logout: `useMutation` POSTing to /api/users/logout with `credentials: 'include'`. onSuccess: setQueryData(['auth', 'me'], null).

CRITICAL: Every fetch call MUST include `credentials: 'include'` -- Payload CMS uses HTTP-only cookies. Without this, auth will silently fail.

**Create `frontend/src/components/ProtectedRoute.tsx`:**

- Import useAuth from hooks
- If isLoading: render a centered spinner/loading indicator (use lucide-react Loader2 with animate-spin)
- If no user: return `<Navigate to="/login" replace />`
- If user exists: render children
- Export as named export `ProtectedRoute`

**Create `frontend/src/pages/LoginPage.tsx`:**

- Full-page centered login form using shadcn/ui Card, Input, Label, Button
- Form fields: email (type="email") and password (type="password")
- Use React Hook Form with Zod schema: email (required, valid email), password (required, min 1 char)
- On submit: call login() from useAuth
- Show error message on failed login (red text below form): "Email ou mot de passe incorrect"
- Show loading state on button while logging in (disable button, show Loader2 spinner)
- On successful login: navigate to /dashboard using useNavigate
- If user already authenticated (check on mount): redirect to /dashboard immediately
- Branding: show "c-sign" title above the card, subtle description "Connectez-vous pour gerer vos evenements"
- Style: max-w-md centered card, clean minimal design matching existing Tailwind patterns
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Verify useAuth exports with grep for 'export function useAuth' in use-auth.ts.
Verify ProtectedRoute renders Navigate on no user with grep for 'Navigate' in ProtectedRoute.tsx.
Verify LoginPage has form with grep for 'login' in LoginPage.tsx.
  </verify>
  <done>
useAuth hook connects to Payload CMS auth endpoints with HTTP-only cookies. ProtectedRoute redirects unauthenticated users to /login. LoginPage has email/password form with error handling and loading states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OrganizerLayout shell and update App.tsx with protected routes</name>
  <files>
    frontend/src/components/OrganizerLayout.tsx
    frontend/src/App.tsx
  </files>
  <action>
**Create `frontend/src/components/OrganizerLayout.tsx`:**

Shell layout for all authenticated organizer pages. Provides consistent navigation header.

Structure:
- Full-height layout: flex flex-col min-h-screen
- Header: fixed top nav with:
  - Left: "c-sign" logo/text link to /dashboard
  - Center/right: navigation links â€” "Evenements" (to /dashboard), "Nouvel evenement" (to /events/new)
  - Right: user display (firstName lastName) + "Deconnexion" button calling logout()
  - Style: white bg, bottom border, px-4 py-3, flex items-center justify-between
- Main content area: flex-1, bg-neutral-50 (light gray background), p-6, max-w-7xl mx-auto w-full
- Children rendered inside main content area
- Use useAuth() to get user info and logout function
- Use useNavigate for logout redirect (navigate to /login after logout)

**Update `frontend/src/App.tsx`:**

Add all Phase 3 routes. Keep existing public routes intact.

New route structure:
```
/ -> HomePage (existing, keep as-is)
/sign/:dayId -> SignPage (existing public route, keep as-is)
/success -> SuccessPage (existing public route, keep as-is)
/login -> LoginPage (new, public)

/dashboard -> ProtectedRoute > OrganizerLayout > DashboardPage
/events/new -> ProtectedRoute > OrganizerLayout > EventCreatePage
/events/:id -> ProtectedRoute > OrganizerLayout > EventDetailPage
```

For DashboardPage, EventCreatePage, and EventDetailPage: create minimal stub components directly in App.tsx or as separate page files. Each stub should render a simple placeholder:
- DashboardPage: `<div><h1>Tableau de bord</h1><p>Plan 03 implementera cette page.</p></div>`
- EventCreatePage: `<div><h1>Nouvel evenement</h1><p>Plan 03 implementera cette page.</p></div>`
- EventDetailPage: `<div><h1>Detail evenement</h1><p>Plan 04 implementera cette page.</p></div>`

Create these stubs as actual page files in `frontend/src/pages/` so Plans 03 and 04 can replace them without modifying App.tsx:
- `frontend/src/pages/DashboardPage.tsx`
- `frontend/src/pages/EventCreatePage.tsx`
- `frontend/src/pages/EventDetailPage.tsx`

Import everything needed in App.tsx. Keep QueryClientProvider wrapper.

IMPORTANT: Use OrganizerLayout INSIDE ProtectedRoute, not outside. The layout needs auth context (user info for header).
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Run `cd /workspace/frontend && npx vite build` to verify production build succeeds.
Verify App.tsx has /login route with grep for '/login' in App.tsx.
Verify App.tsx has /dashboard route with grep for '/dashboard' in App.tsx.
Verify App.tsx has ProtectedRoute wrapper with grep for 'ProtectedRoute' in App.tsx.
Verify OrganizerLayout has logout with grep for 'logout' in OrganizerLayout.tsx.
  </verify>
  <done>
OrganizerLayout provides consistent header with navigation and logout. App.tsx has all routes configured: public (sign, success, login) and protected (dashboard, events/new, events/:id). Page stubs created for Plans 03 and 04 to implement. Full frontend compiles and builds successfully.
  </done>
</task>

</tasks>

<verification>
- `cd /workspace/frontend && npx tsc --noEmit` passes
- `cd /workspace/frontend && npx vite build` succeeds
- LoginPage renders form with email and password fields
- ProtectedRoute redirects to /login when unauthenticated
- OrganizerLayout shows navigation header with user info
- App.tsx has routes for /login, /dashboard, /events/new, /events/:id
- Protected routes are wrapped in ProtectedRoute > OrganizerLayout
- All fetch calls use credentials: 'include'
</verification>

<success_criteria>
Organizer can navigate to /login, enter credentials, authenticate against Payload CMS, and be redirected to /dashboard. Unauthenticated access to /dashboard redirects to /login. Organizer can log out from header. Protected route shell is ready for Plans 03 and 04 to fill with real page content.
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-management/03-02-SUMMARY.md`
</output>
