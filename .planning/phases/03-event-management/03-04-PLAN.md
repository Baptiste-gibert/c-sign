---
phase: 03-event-management
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - frontend/src/pages/EventDetailPage.tsx
  - frontend/src/hooks/use-participants.ts
  - frontend/src/hooks/use-attendance.ts
  - frontend/src/components/ParticipantSearch.tsx
  - frontend/src/components/ParticipantTable.tsx
  - frontend/src/components/AttendanceDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Organizer can search mock SIMV registry by name or registration number"
    - "Organizer can add participants from search results to event's pre-populated list"
    - "Organizer can remove participants from event's pre-populated list"
    - "Organizer can add walk-in participants manually (without SIMV search)"
    - "Organizer can see real-time attendance status showing who has signed per session"
    - "Event status can be changed between draft/open/finalized from event detail page"
  artifacts:
    - path: "frontend/src/pages/EventDetailPage.tsx"
      provides: "Event detail with tabs for participants and attendance"
      min_lines: 60
    - path: "frontend/src/hooks/use-participants.ts"
      provides: "SIMV search and participant management hooks"
      exports: ["useSimvSearch", "useAddParticipant", "useRemoveParticipant"]
    - path: "frontend/src/hooks/use-attendance.ts"
      provides: "Real-time attendance polling hook"
      exports: ["useAttendanceDashboard"]
    - path: "frontend/src/components/ParticipantSearch.tsx"
      provides: "Combobox for searching SIMV registry"
      min_lines: 40
    - path: "frontend/src/components/ParticipantTable.tsx"
      provides: "Data table for participant list management"
      min_lines: 40
    - path: "frontend/src/components/AttendanceDashboard.tsx"
      provides: "Real-time signing status per session"
      min_lines: 40
  key_links:
    - from: "frontend/src/hooks/use-participants.ts"
      to: "/api/simv/search"
      via: "fetch (intercepted by MSW in dev)"
      pattern: "simv/search"
    - from: "frontend/src/hooks/use-participants.ts"
      to: "/api/events"
      via: "PATCH to update event participants array"
      pattern: "api/events"
    - from: "frontend/src/hooks/use-attendance.ts"
      to: "/api/signatures"
      via: "fetch signatures for event sessions"
      pattern: "api/signatures"
    - from: "frontend/src/components/ParticipantSearch.tsx"
      to: "frontend/src/hooks/use-participants.ts"
      via: "useSimvSearch hook"
      pattern: "useSimvSearch"
    - from: "frontend/src/components/AttendanceDashboard.tsx"
      to: "frontend/src/hooks/use-attendance.ts"
      via: "useAttendanceDashboard hook with polling"
      pattern: "useAttendanceDashboard"
---

<objective>
Build the event detail page with participant management (SIMV search, add/remove, walk-ins) and real-time attendance dashboard showing signing status.

Purpose: Implements PART-01 (pre-populate participants), PART-02 (SIMV search), PART-03 (add/remove participants), PART-04 (walk-in participants), EVNT-04 (status workflow UI), and the attendance monitoring dashboard. This is the most feature-rich page in the application.

Output: Working EventDetailPage with participant search/management, walk-in quick-add, attendance dashboard with per-session signing status, and event status controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-event-management/03-RESEARCH.md
@.planning/phases/03-event-management/03-01-SUMMARY.md
@.planning/phases/03-event-management/03-02-SUMMARY.md
@backend/src/collections/Events.ts
@backend/src/collections/Sessions.ts
@backend/src/collections/Signatures.ts
@backend/src/collections/Participants.ts
@backend/src/collections/AttendanceDays.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create participant management hooks, SIMV search, and attendance polling hook</name>
  <files>
    frontend/src/hooks/use-participants.ts
    frontend/src/hooks/use-attendance.ts
  </files>
  <action>
**Create `frontend/src/hooks/use-participants.ts`:**

Hooks for SIMV search and event participant management. ALL fetch calls MUST use `credentials: 'include'`.

1. **`useSimvSearch(query: string)`**: useQuery hook
   - queryKey: ['simv', 'search', query]
   - queryFn: fetch GET /api/simv/search?q={query} (this is intercepted by MSW in dev)
   - enabled: query.length >= 2 (don't search on empty/1-char input)
   - staleTime: 30 seconds (same search term, same results)
   - Returns array of SimvParticipant: { id, lastName, firstName, email, city, professionalNumber?, beneficiaryType }

2. **`useAddParticipant(eventId: string)`**: useMutation hook
   - Adds a participant to the event's pre-populated list
   - Strategy: First create participant in Payload (POST /api/participants), then PATCH /api/events/{eventId} to add participant ID to the `participants` array
   - IMPORTANT: To add to array without replacing, first GET the event to read current participants, then PATCH with the merged array
   - On success: invalidateQueries(['events', eventId]) to refresh event data
   - Accept participant data as mutation input (lastName, firstName, email, city, professionalNumber, beneficiaryType)

3. **`useRemoveParticipant(eventId: string)`**: useMutation hook
   - Removes a participant from the event's pre-populated list
   - Strategy: GET event to read current participants array, filter out the participant ID, PATCH /api/events/{eventId} with remaining IDs
   - Does NOT delete the Participant record (may be referenced by signatures)
   - On success: invalidateQueries(['events', eventId])
   - Accept participantId as mutation input

4. **`useAddWalkIn(eventId: string)`**: useMutation hook
   - Creates a new participant (POST /api/participants with manual input data) and adds to event
   - Same flow as useAddParticipant but accepts raw form data instead of SIMV result
   - On success: invalidateQueries(['events', eventId])

**Create `frontend/src/hooks/use-attendance.ts`:**

Hook for real-time attendance monitoring. Uses TanStack Query polling.

1. **`useAttendanceDashboard(eventId: string)`**: useQuery hook
   - queryKey: ['attendance', eventId]
   - queryFn: Multi-step client-side aggregation:
     a. GET /api/events/{eventId}?depth=0 to get event with attendanceDays IDs and participants IDs
     b. For each attendanceDayId: GET /api/sessions?where[attendanceDay][equals]={dayId}&depth=0 to get sessions
     c. For each sessionId: GET /api/signatures?where[session][equals]={sessionId}&depth=1 to get signatures with participant info
     d. GET /api/attendance-days/{dayId}?depth=0 for date info
     e. Aggregate into structure:
        ```
        {
          attendanceDays: [{
            id, date,
            sessions: [{
              id, name,
              signatures: [{ id, participant: { id, lastName, firstName }, createdAt }],
              signedCount: number,
              totalExpected: number (from event.participants.length)
            }]
          }]
        }
        ```
   - refetchInterval: 10000 (10 seconds) for real-time updates
   - refetchIntervalInBackground: true
   - staleTime: 5000

   NOTE: This multi-fetch approach works for MVP scale (10-50 participants). If performance becomes an issue, a dedicated backend endpoint can be added in Phase 4.

   OPTIMIZATION: Use Promise.all for parallel fetching where possible (e.g., fetch all attendance days in parallel).
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Verify useSimvSearch exists with grep for 'useSimvSearch' in use-participants.ts.
Verify useAddParticipant exists with grep for 'useAddParticipant' in use-participants.ts.
Verify useAttendanceDashboard has polling with grep for 'refetchInterval' in use-attendance.ts.
  </verify>
  <done>
useSimvSearch queries mock SIMV registry with debounced search. useAddParticipant/useRemoveParticipant manage event participant list via Payload API. useAddWalkIn creates participant and adds to event. useAttendanceDashboard aggregates signing data with 10-second polling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build EventDetailPage with ParticipantSearch, ParticipantTable, AttendanceDashboard, and status controls</name>
  <files>
    frontend/src/components/ParticipantSearch.tsx
    frontend/src/components/ParticipantTable.tsx
    frontend/src/components/AttendanceDashboard.tsx
    frontend/src/pages/EventDetailPage.tsx
  </files>
  <action>
**Create `frontend/src/components/ParticipantSearch.tsx`:**

Combobox for searching SIMV registry using shadcn/ui Popover + Command pattern.

- Popover trigger: Button with Search icon, text "Rechercher dans le registre SIMV..."
- PopoverContent contains Command with:
  - CommandInput: placeholder "Nom ou numero d'inscription...", value bound to search state
  - CommandList with CommandEmpty ("Aucun resultat" or "Recherche..." if loading)
  - CommandGroup with results from useSimvSearch(search)
  - Each CommandItem shows: "{lastName} {firstName}" and professionalNumber as subtitle
- On select: call onSelect prop with selected participant, close popover, clear search
- Props: `onSelect: (participant: SimvParticipant) => void`, `disabled?: boolean`

**Create `frontend/src/components/ParticipantTable.tsx`:**

Data table using TanStack Table + shadcn/ui Table for managing participant list.

- Columns using ColumnDef<Participant>:
  1. Nom (lastName) — sortable
  2. Prenom (firstName) — sortable
  3. Email (email)
  4. Ville (city)
  5. Type (beneficiaryType) — map to French label
  6. N inscription (professionalNumber) — show "-" if empty
  7. Actions — Remove button (Trash2 icon) calling onRemove(participantId)

- Props: `data: Participant[]`, `onRemove: (id: string) => void`, `isLoading?: boolean`
- Use getCoreRowModel and getSortedRowModel from TanStack Table
- Empty state: "Aucun participant pre-inscrit"
- Show total count above table: "{n} participant(s)"

**Create `frontend/src/components/AttendanceDashboard.tsx`:**

Real-time signing status display.

- Props: `eventId: string`
- Use useAttendanceDashboard(eventId) hook
- Loading state: skeleton/spinner
- For each attendance day:
  - Show formatted date as section header (date-fns format, French locale)
  - For each session in that day:
    - Show session name
    - Progress indicator: "{signedCount} / {totalExpected} presents" with progress bar or fraction
    - Participant list: each shows "{lastName} {firstName}" with status icon:
      - Signed: green CheckCircle + "Signe" + timestamp
      - Pending: gray Clock + "En attente"
- If no attendance days: show "Aucune journee de presence"
- Auto-updating: visual indicator that data is live (e.g., small pulsing dot or "Mise a jour automatique" text)

**Replace stub `frontend/src/pages/EventDetailPage.tsx`:**

Main event detail page combining all components. This is the richest page in the app.

Structure:
- Get eventId from useParams
- Use useEvent(eventId) from use-events.ts hook (created in Plan 03)
  NOTE: Import useEvent from '@/hooks/use-events' (created by Plan 03). If Plan 03 hasn't run yet or file doesn't exist, the executor will need to create a minimal version. Since Plans 03 and 04 are Wave 3 (parallel), handle this gracefully: if useEvent doesn't exist yet, create a local version in this file or in use-events.ts.
- Loading state while event loads
- Error state if event not found

Layout:
- Top section: Event title (h1), location, organizer, expense type badge, dates
- Status section: Current status badge + status change buttons:
  - If draft: "Ouvrir l'evenement" button (changes to open)
  - If open: "Finaliser l'evenement" button (changes to finalized)
  - If finalized: "Evenement finalise" text (no action, grayed out)
  - Use useUpdateEvent for status changes, confirm with window.confirm for finalize
- QR code section: For each attendance day, show a link "Voir QR code" that navigates to the Payload admin or shows inline QR code (use qrcode.react already installed). QR code URL format: `{window.location.origin}/sign/{dayId}`

Two sections below (can be tabs or vertical sections):

**Section 1: Participants ({count})**
- ParticipantSearch component (disabled if event is finalized)
- Walk-in quick-add: expandable form with lastName, firstName, email, city, beneficiaryType fields + "Ajouter" button. Use a simple form (not React Hook Form -- keep it lightweight). This creates a participant AND adds to event list.
- ParticipantTable showing event.participants with remove action (disabled if finalized)

**Section 2: Presence en direct**
- AttendanceDashboard component with eventId
- Only meaningful when event is open (show message if draft: "Ouvrez l'evenement pour voir la presence en direct")

For status changes, use useUpdateEvent from Plan 03's use-events.ts. Same note as above about parallel plan execution -- create local if needed.

Handle parallel plan execution: Since this plan runs in Wave 3 alongside Plan 03, the useEvent and useUpdateEvent hooks may or may not exist. Strategy:
1. First check if `frontend/src/hooks/use-events.ts` exists
2. If yes, import from it
3. If no, create the useEvent and useUpdateEvent hooks directly in use-events.ts (they won't conflict with Plan 03's implementation since Plan 03 creates the same file with compatible exports)

IMPORTANT: If creating use-events.ts, include ALL hooks that Plan 03 specifies (useEvents, useCreateEvent, useEvent, useUpdateEvent) to avoid file conflicts.
  </action>
  <verify>
Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.
Run `cd /workspace/frontend && npx vite build` to verify production build succeeds.
Verify ParticipantSearch uses Command pattern with grep for 'Command' in ParticipantSearch.tsx.
Verify ParticipantTable uses TanStack Table with grep for 'useReactTable' in ParticipantTable.tsx.
Verify AttendanceDashboard has polling with grep for 'useAttendanceDashboard' in AttendanceDashboard.tsx.
Verify EventDetailPage has status controls with grep for 'status' in EventDetailPage.tsx.
Verify EventDetailPage has QR code with grep for 'QRCode\|qrcode' in EventDetailPage.tsx.
  </verify>
  <done>
EventDetailPage shows full event details with status controls (draft->open->finalized), QR codes per attendance day, ParticipantSearch (SIMV combobox), walk-in quick-add form, ParticipantTable with remove action, and live AttendanceDashboard with 10-second polling. All participant operations (search, add, remove, walk-in) are functional.
  </done>
</task>

</tasks>

<verification>
- `cd /workspace/frontend && npx tsc --noEmit` passes
- `cd /workspace/frontend && npx vite build` succeeds
- ParticipantSearch renders Combobox with SIMV search results
- ParticipantTable renders sortable table with remove action
- AttendanceDashboard shows per-session signing status with polling
- EventDetailPage shows event info, status controls, participants section, and attendance section
- SIMV search filters by name and professional number
- Adding participant from search adds to event's participants array
- Removing participant removes from event's participants array
- Walk-in quick-add creates participant and adds to event
- Status buttons change event status via PATCH API
- QR codes displayed per attendance day
</verification>

<success_criteria>
Organizer can view event details, search SIMV registry to add participants, manually add walk-ins, remove participants from list, see real-time attendance status per session, change event status through draft->open->finalized workflow, and view QR codes for each attendance day. All features work with Payload CMS REST API and MSW mock data.
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-management/03-04-SUMMARY.md`
</output>
