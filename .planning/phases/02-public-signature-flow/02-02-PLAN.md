---
phase: 02-public-signature-flow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/collections/Participants.ts
  - backend/src/collections/Signatures.ts
  - backend/src/collections/Media.ts
  - backend/src/collections/AttendanceDays.ts
  - backend/src/collections/Sessions.ts
  - backend/src/app/(payload)/api/qr-code/route.ts
autonomous: true

must_haves:
  truths:
    - "Anonymous user can POST to /api/participants and create a participant without authentication"
    - "Anonymous user can POST to /api/signatures with file upload and create a signature without authentication"
    - "Anonymous user can GET /api/attendance-days/:id to read day info without authentication"
    - "Anonymous user can GET /api/sessions filtered by attendanceDay without authentication"
    - "QR code endpoint returns data URL and sign URL for a given dayId"
  artifacts:
    - path: "backend/src/collections/Participants.ts"
      provides: "Public create access for participant form"
      contains: "create: () => true"
    - path: "backend/src/collections/Signatures.ts"
      provides: "Public create access for signature upload"
      contains: "create: () => true"
    - path: "backend/src/collections/Media.ts"
      provides: "Public create access for signature image upload"
      contains: "create: () => true"
    - path: "backend/src/app/(payload)/api/qr-code/route.ts"
      provides: "QR code generation API endpoint"
      contains: "QRCode"
  key_links:
    - from: "frontend /sign/:dayId form"
      to: "/api/participants"
      via: "POST with JSON body"
      pattern: "create: \\(\\) => true"
    - from: "frontend /sign/:dayId canvas"
      to: "/api/signatures"
      via: "POST with FormData (file + _payload)"
      pattern: "create: \\(\\) => true"
    - from: "frontend /sign/:dayId page load"
      to: "/api/attendance-days"
      via: "GET to fetch day info and sessions"
      pattern: "read:.*true"
---

<objective>
Update Payload CMS access control to allow public (unauthenticated) creation of Participants, Signatures, and Media uploads. Add public read access to AttendanceDays and Sessions so the signing page can load event context. Create QR code generation API endpoint.

Purpose: The public signing flow requires anonymous users (participants scanning QR codes) to submit form data and signature images without logging in. Current access control requires authentication for all operations -- this must be opened for specific create/read operations while keeping update/delete restricted to authenticated users.

Output: Backend collections with public access for the signing flow, plus a QR code generation endpoint at /api/qr-code.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-public-signature-flow/02-RESEARCH.md
@backend/src/collections/Participants.ts
@backend/src/collections/Signatures.ts
@backend/src/collections/Media.ts
@backend/src/collections/AttendanceDays.ts
@backend/src/collections/Sessions.ts
@backend/src/payload.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update access control for public signing flow</name>
  <files>
    backend/src/collections/Participants.ts
    backend/src/collections/Signatures.ts
    backend/src/collections/Media.ts
    backend/src/collections/AttendanceDays.ts
    backend/src/collections/Sessions.ts
  </files>
  <action>
    Update access control on 5 collections to enable the public signing flow. Be surgical -- only change the `access` object, leave all fields, hooks, and admin config unchanged.

    **1. Participants.ts** -- Public create + read (participants need to be created by anonymous users, and the form may need to check for existing participants):
    ```typescript
    access: {
      create: () => true,              // Public form creates participants
      read: () => true,                // Public: needed for duplicate checking
      update: ({ req: { user } }) => !!user,  // Only authenticated users
      delete: ({ req: { user } }) => !!user,  // Only authenticated users
    },
    ```

    **2. Signatures.ts** -- Public create only (anonymous users upload signatures, but cannot read/modify them):
    ```typescript
    access: {
      create: () => true,              // Public signing flow uploads signatures
      read: ({ req: { user } }) => !!user,    // Only authenticated users can view
      update: isAdmin,                         // Keep existing
      delete: isAdmin,                         // Keep existing
    },
    ```

    **3. Media.ts** -- Public create only (signature images need to be uploaded by anonymous users). Read the current Media.ts first to understand its structure, then update:
    ```typescript
    access: {
      create: () => true,              // Public: signature images uploaded by anonymous users
      read: () => true,                // Public: images may need to be served
      // Keep existing update/delete restrictions
    },
    ```

    **4. AttendanceDays.ts** -- Add public read (signing page needs to load day info to display event context):
    ```typescript
    access: {
      create: () => false,                     // Keep: only system hooks create
      read: () => true,                        // Public: signing page loads day info
      update: isAdmin,                         // Keep existing
      delete: isAdmin,                         // Keep existing
    },
    ```

    **5. Sessions.ts** -- Add public read (signing page needs to list available sessions for the day):
    ```typescript
    access: {
      create: ({ req: { user } }) => !!user,  // Keep: only organizers create sessions
      read: () => true,                        // Public: signing page lists sessions
      update: ({ req: { user } }) => !!user,  // Keep existing
      delete: isAdmin,                         // Keep existing
    },
    ```

    IMPORTANT: Do NOT change any fields, hooks, admin config, or other collection properties. Only modify the `access` object.

    Security note: Public create is safe here because:
    - Participants: only stores form data, no sensitive operations
    - Signatures: beforeChange hook already enforces uniqueness (one per participant-session)
    - Media: only accepts image files via Payload's built-in upload validation
    - Rate limiting is not needed for MVP (internal use case with ~800 events/year)
  </action>
  <verify>
    Run `cd /workspace/backend && npx tsc --noEmit` to verify TypeScript compilation.
    Grep for `create: () => true` in Participants.ts, Signatures.ts, Media.ts.
    Grep for `read: () => true` in AttendanceDays.ts, Sessions.ts.
    Verify no fields, hooks, or admin config were accidentally modified by diffing against git.
  </verify>
  <done>
    Participants, Signatures, and Media collections allow public create. AttendanceDays and Sessions allow public read. All other access restrictions unchanged. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QR code generation API endpoint</name>
  <files>
    backend/src/app/(payload)/api/qr-code/route.ts
  </files>
  <action>
    1. Install the qrcode package in the backend:
       ```bash
       cd /workspace/backend && npm install qrcode && npm install -D @types/qrcode
       ```

    2. Create the QR code API route at `backend/src/app/(payload)/api/qr-code/route.ts`:

    ```typescript
    import { NextRequest, NextResponse } from 'next/server'
    import QRCode from 'qrcode'

    export async function GET(req: NextRequest) {
      const searchParams = req.nextUrl.searchParams
      const dayId = searchParams.get('dayId')

      if (!dayId) {
        return NextResponse.json(
          { error: 'dayId query parameter is required' },
          { status: 400 }
        )
      }

      // Construct the public signing URL
      // In production, this would be the public frontend URL
      const baseUrl = process.env.NEXT_PUBLIC_FRONTEND_URL || 'http://localhost:5173'
      const signUrl = `${baseUrl}/sign/${dayId}`

      try {
        // Generate QR code as data URL (base64 PNG)
        const qrDataUrl = await QRCode.toDataURL(signUrl, {
          width: 512,
          margin: 2,
          errorCorrectionLevel: 'M',
          color: {
            dark: '#000000',
            light: '#FFFFFF',
          },
        })

        return NextResponse.json({
          qrDataUrl,
          signUrl,
          dayId,
        })
      } catch (error) {
        console.error('QR code generation error:', error)
        return NextResponse.json(
          { error: 'Failed to generate QR code' },
          { status: 500 }
        )
      }
    }
    ```

    This endpoint:
    - Accepts GET /api/qr-code?dayId=123
    - Returns JSON with qrDataUrl (base64 PNG), signUrl (the URL encoded in QR), and dayId
    - Does NOT require authentication (QR codes are for public distribution)
    - Uses error correction level M (15% recovery, good balance of density vs resilience)

    Note: This route sits alongside the existing `[...slug]/route.ts` catch-all but takes precedence because it's a more specific path match.
  </action>
  <verify>
    Run `cd /workspace/backend && npx tsc --noEmit` to verify TypeScript compilation.
    Verify file exists at backend/src/app/(payload)/api/qr-code/route.ts.
    Verify qrcode package is in backend/package.json dependencies.
  </verify>
  <done>
    QR code endpoint exists at /api/qr-code?dayId=X. Returns JSON with qrDataUrl and signUrl. Backend compiles without errors. qrcode package installed.
  </done>
</task>

</tasks>

<verification>
1. `cd /workspace/backend && npx tsc --noEmit` passes
2. Participants.ts has `create: () => true`
3. Signatures.ts has `create: () => true`
4. Media.ts has `create: () => true`
5. AttendanceDays.ts has `read: () => true`
6. Sessions.ts has `read: () => true`
7. backend/src/app/(payload)/api/qr-code/route.ts exists and exports GET function
8. qrcode is in backend/package.json dependencies
</verification>

<success_criteria>
- All 5 collection access control updates compiled and verified
- QR code API endpoint created and compiles
- No existing collection functionality (fields, hooks, admin) was changed
- Backend TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-signature-flow/02-02-SUMMARY.md`
</output>
