---
phase: 02-public-signature-flow
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Full signing flow works end-to-end: scan QR -> fill form -> sign -> submit -> see confirmation"
    - "Participant record created in Payload with correct data"
    - "Signature image stored in Media collection"
    - "Signature record links participant, session, and media correctly"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete public signing flow end-to-end with both backend and frontend running. Human tester validates the flow works on a real browser.

Purpose: This is the core product feature -- if the signing flow doesn't work, nothing else matters. Must verify: form fields render, validation works, signature canvas captures input, submission succeeds, confirmation displays, and data is correctly stored in Payload.

Output: Human verification that the signing flow works. Issues logged for gap closure if needed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-public-signature-flow/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start services and prepare test data</name>
  <files></files>
  <action>
    1. Ensure PostgreSQL is running (should already be up from docker-compose).

    2. Start the Payload backend:
       ```bash
       cd /workspace/backend && npm run dev &
       ```
       Wait for it to be ready on port 3000.

    3. Run seed data to ensure test events and sessions exist:
       ```bash
       curl http://localhost:3000/api/seed
       ```
       This creates test events with attendance days and sessions.

    4. Get a valid attendance day ID for testing:
       ```bash
       curl http://localhost:3000/api/attendance-days?limit=1
       ```
       Note the ID of the first attendance day.

    5. Verify sessions exist for that attendance day:
       ```bash
       curl "http://localhost:3000/api/sessions?where[attendanceDay][equals]={dayId}"
       ```
       If no sessions exist, the test will fail -- the signing page requires at least one session.

    6. Start the Vite frontend:
       ```bash
       cd /workspace/frontend && npm run dev &
       ```
       Wait for it to be ready on port 5173.

    7. Test QR code generation:
       ```bash
       curl "http://localhost:3000/api/qr-code?dayId={dayId}"
       ```
       Verify it returns JSON with qrDataUrl and signUrl.

    8. Print the sign URL for the human tester:
       ```
       Sign URL: http://localhost:5173/sign/{dayId}
       ```
  </action>
  <verify>
    Both servers running (backend :3000, frontend :5173).
    Seed data loaded with at least one event, attendance day, and session.
    QR code endpoint returns valid response.
    Sign URL is accessible in browser.
  </verify>
  <done>
    Both services running, test data seeded, sign URL ready for human testing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete signing flow</name>
  <files></files>
  <action>
    Present the following verification checklist to the user and wait for their response.

    Complete public signing flow was built across Plans 01-03: frontend scaffold, backend public access, signing page UI.

    **Test the sign URL provided by Task 1** (http://localhost:5173/sign/{dayId})

    **Test 1 - Page Load:**
    1. Open the sign URL in browser
    2. EXPECTED: Page loads showing event info (title, date) and the participant form
    3. EXPECTED: Session selector visible (if multiple sessions) or auto-selected (if one)

    **Test 2 - Form Validation:**
    1. Click "Signer" without filling any fields
    2. EXPECTED: Validation errors appear in French for required fields (Nom, Prenom, Email, Ville, Type de beneficiaire)
    3. Enter invalid email (e.g., "notanemail")
    4. EXPECTED: "Email invalide" error message

    **Test 3 - Beneficiary Type:**
    1. Select "Autre" from beneficiary type dropdown
    2. EXPECTED: "Preciser le type" field appears
    3. Try to submit without filling it
    4. EXPECTED: Validation error on the "Preciser" field

    **Test 4 - Signature Canvas:**
    1. Draw a signature on the canvas (use mouse or touch)
    2. EXPECTED: Smooth drawing, no lag
    3. Click "Effacer" button
    4. EXPECTED: Canvas clears completely
    5. Draw signature again

    **Test 5 - Successful Submission:**
    1. Fill all required fields with valid data:
       - Nom: Dupont
       - Prenom: Marie
       - Email: marie@test.com
       - Ville: Lyon
       - Type: Veterinaire
    2. Draw a signature
    3. Check (or don't check) the right-to-image consent checkbox
    4. Click "Signer"
    5. EXPECTED: Button shows "Envoi en cours..." briefly
    6. EXPECTED: Redirected to /success page with confirmation message

    **Test 6 - Data Verification (in Payload admin):**
    1. Go to http://localhost:3000/admin
    2. Log in as admin@ceva.com / Test1234!
    3. Check Participants: new "Dupont Marie" record exists with correct fields
    4. Check Media: new signature image exists
    5. Check Signatures: new record links the participant, session, and media image

    **Report any issues with specific test number and description.**
  </action>
  <verify>
    User confirms all 6 tests pass, or reports specific failures for gap closure.
  </verify>
  <done>
    Human approved the complete signing flow. All SIGN requirements verified: form fields (SIGN-03), signature canvas (SIGN-04), server upload (SIGN-05), consent checkbox (SIGN-06), confirmation (SIGN-07).
  </done>
</task>

</tasks>

<verification>
Human verification covers all SIGN requirements:
- SIGN-01: QR code generation verified via curl (full QR display is Phase 3 organizer UI)
- SIGN-02: Participant opens form via URL without login
- SIGN-03: Form has all required fields
- SIGN-04: Signature canvas works with touch/mouse
- SIGN-05: Signature uploaded as image to server
- SIGN-06: Right-to-image consent checkbox present
- SIGN-07: Success confirmation displayed
</verification>

<success_criteria>
- Human confirms all 6 tests pass
- Data correctly stored in Payload (participant, media, signature records)
- No JavaScript errors in console
- Form validation works in French
- Signature canvas draws smoothly
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-signature-flow/02-04-SUMMARY.md`
</output>
