---
phase: 08-security-access
plan: 06
type: execute
wave: 3
depends_on: ["08-03", "08-05"]
files_modified:
  - backend/src/lib/security/rateLimit.ts
  - backend/src/lib/security/captcha.ts
  - backend/src/lib/security/fingerprint.ts
  - backend/src/views/SignPage.tsx
  - backend/src/lib/api.ts
  - backend/src/app/(payload)/api/signatures/check-rate/route.ts
autonomous: true
user_setup:
  - service: cloudflare-turnstile
    why: "Dynamic CAPTCHA for abuse detection on public signing endpoints"
    env_vars:
      - name: NEXT_PUBLIC_TURNSTILE_SITE_KEY
        source: "Cloudflare Dashboard -> Turnstile -> Add Widget -> copy Site Key"
      - name: TURNSTILE_SECRET_KEY
        source: "Cloudflare Dashboard -> Turnstile -> Add Widget -> copy Secret Key"
    dashboard_config:
      - task: "Create a Cloudflare account (free) and add a Turnstile widget"
        location: "https://dash.cloudflare.com -> Turnstile -> Add Widget"
      - task: "Set widget mode to 'Managed' (invisible when possible, interactive when needed)"
        location: "Widget settings -> Mode"
      - task: "Add production domain to allowed hostnames"
        location: "Widget settings -> Hostname"

must_haves:
  truths:
    - "Device fingerprinting tracks submission rate per device (not per IP)"
    - "Rate limiting triggers CAPTCHA challenge after suspicious volume"
    - "Hard rate limit blocks submissions after extreme volume"
    - "CAPTCHA is invisible/frictionless for normal users"
    - "CAPTCHA only appears when rate limit triggers it"
    - "Turnstile tokens are verified server-side"
  artifacts:
    - path: "backend/src/lib/security/rateLimit.ts"
      provides: "In-memory device fingerprint-based rate limiter"
      exports: ["checkRateLimit"]
    - path: "backend/src/lib/security/captcha.ts"
      provides: "Turnstile server-side token verification"
      exports: ["verifyTurnstileToken"]
    - path: "backend/src/lib/security/fingerprint.ts"
      provides: "Client-side device fingerprint collection"
      exports: ["getFingerprint"]
    - path: "backend/src/views/SignPage.tsx"
      provides: "Dynamic CAPTCHA widget in signing form"
      contains: "turnstile"
  key_links:
    - from: "backend/src/lib/security/fingerprint.ts"
      to: "backend/src/views/SignPage.tsx"
      via: "getFingerprint() called before form submission"
      pattern: "getFingerprint"
    - from: "backend/src/views/SignPage.tsx"
      to: "backend/src/lib/api.ts"
      via: "fingerprint and captchaToken sent with API calls"
      pattern: "deviceFingerprint"
    - from: "backend/src/lib/security/rateLimit.ts"
      to: "API rate check endpoint"
      via: "checkRateLimit called in API handler"
      pattern: "checkRateLimit"
    - from: "backend/src/lib/security/captcha.ts"
      to: "API signature creation"
      via: "verifyTurnstileToken in signature endpoint"
      pattern: "verifyTurnstileToken"
---

<objective>
Add device fingerprint-based rate limiting and dynamic Cloudflare Turnstile CAPTCHA for public signing endpoints.

Purpose: Prevent spam and automated abuse of public endpoints (participant creation, signature submission) without blocking legitimate attendees sharing the same WiFi. Rate limiting is device-based (not IP-based per user decision). CAPTCHA is invisible by default and only triggers when suspicious volume is detected.
Output: Client-side fingerprinting, server-side rate limiter, Turnstile CAPTCHA integration, updated signing flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-security-access/08-RESEARCH.md
@.planning/phases/08-security-access/08-03-SUMMARY.md
@.planning/phases/08-security-access/08-05-SUMMARY.md
@backend/src/views/SignPage.tsx
@backend/src/lib/api.ts
@backend/src/hooks/use-signature-submission.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side rate limiting and CAPTCHA verification utilities</name>
  <files>backend/src/lib/security/rateLimit.ts, backend/src/lib/security/captcha.ts, backend/src/app/(payload)/api/signatures/check-rate/route.ts</files>
  <action>
1. Install FingerprintJS:
   ```bash
   cd /workspace/backend && npm install @fingerprintjs/fingerprintjs
   ```
   Note: No npm package needed for Turnstile client-side — it loads via script tag. For Turnstile server verification, we use plain fetch (no package needed).

2. Create `backend/src/lib/security/rateLimit.ts`:
   - In-memory rate limit store using a Map:
     ```typescript
     interface RateLimitEntry {
       count: number
       firstSeen: number
     }
     const store = new Map<string, RateLimitEntry>()
     ```
   - Export `checkRateLimit(fingerprint: string, maxRequests?: number, windowMs?: number)`:
     - Default: maxRequests = 10, windowMs = 60000 (10 per minute — conservative to tolerate fingerprint instability)
     - Returns: `{ allowed: boolean, shouldChallenge: boolean }`
     - Logic:
       - If no entry or window expired: create new entry, `{ allowed: true, shouldChallenge: false }`
       - If count <= maxRequests: increment, `{ allowed: true, shouldChallenge: false }`
       - If count > maxRequests and <= maxRequests * 2: increment, `{ allowed: true, shouldChallenge: true }` (trigger CAPTCHA)
       - If count > maxRequests * 2: `{ allowed: false, shouldChallenge: false }` (hard block)
   - Add cleanup interval: every 60 seconds, delete entries older than 2x windowMs
   - Export `resetRateLimitStore()` for testing

3. Create `backend/src/lib/security/captcha.ts`:
   - Export `verifyTurnstileToken(token: string): Promise<boolean>`:
     ```typescript
     export async function verifyTurnstileToken(token: string): Promise<boolean> {
       const secret = process.env.TURNSTILE_SECRET_KEY
       if (!secret) {
         console.warn('TURNSTILE_SECRET_KEY not configured — skipping CAPTCHA verification')
         return true // Allow in dev when not configured
       }

       try {
         const response = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ secret, response: token }),
         })
         const data = await response.json()
         return data.success === true
       } catch (error) {
         console.error('Turnstile verification failed:', error)
         return false
       }
     }
     ```

4. Create a rate check API endpoint `backend/src/app/(payload)/api/signatures/check-rate/route.ts`:
   - POST endpoint that receives `{ deviceFingerprint }` in the body
   - Calls `checkRateLimit(deviceFingerprint)` and returns the result
   - If `shouldChallenge: true`, the response tells the client to show CAPTCHA
   - If `allowed: false`, returns 429 status
   - This endpoint is called BEFORE the actual signature submission to determine if CAPTCHA is needed

   ```typescript
   import { NextRequest, NextResponse } from 'next/server'
   import { checkRateLimit } from '@/lib/security/rateLimit'

   export async function POST(req: NextRequest) {
     const body = await req.json()
     const { deviceFingerprint } = body

     if (!deviceFingerprint) {
       return NextResponse.json({ allowed: true, shouldChallenge: false })
     }

     const result = checkRateLimit(deviceFingerprint)

     if (!result.allowed) {
       return NextResponse.json(
         { error: 'Trop de soumissions. Veuillez reessayer plus tard.' },
         { status: 429 }
       )
     }

     return NextResponse.json(result)
   }
   ```
  </action>
  <verify>
- Rate limiter exists: `ls backend/src/lib/security/rateLimit.ts`
- CAPTCHA verifier exists: `ls backend/src/lib/security/captcha.ts`
- Rate check endpoint exists: `ls backend/src/app/(payload)/api/signatures/check-rate/route.ts`
- Package installed: `grep "fingerprintjs" backend/package.json`
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>Server-side rate limiting with in-memory store, Turnstile verification utility, and rate check API endpoint are implemented</done>
</task>

<task type="auto">
  <name>Task 2: Client-side fingerprinting and dynamic CAPTCHA in signing flow</name>
  <files>backend/src/lib/security/fingerprint.ts, backend/src/views/SignPage.tsx, backend/src/lib/api.ts, backend/src/hooks/use-signature-submission.ts</files>
  <action>
1. Create `backend/src/lib/security/fingerprint.ts` (client-side utility):
   ```typescript
   'use client'
   import FingerprintJS from '@fingerprintjs/fingerprintjs'

   let fpPromise: ReturnType<typeof FingerprintJS.load> | null = null

   export async function getFingerprint(): Promise<string> {
     if (!fpPromise) {
       fpPromise = FingerprintJS.load()
     }
     const fp = await fpPromise
     const result = await fp.get()
     return result.visitorId
   }
   ```
   Mark with `'use client'` since FingerprintJS runs in the browser only.

2. Update `backend/src/views/SignPage.tsx`:
   - Import `getFingerprint` from `@/lib/security/fingerprint`
   - Add state: `const [showCaptcha, setShowCaptcha] = useState(false)`
   - Add state: `const [captchaToken, setCaptchaToken] = useState<string | null>(null)`
   - Modify `handleSubmit` to:
     a. Get device fingerprint: `const fingerprint = await getFingerprint()`
     b. Check rate limit BEFORE submission: call `/api/signatures/check-rate` with the fingerprint
     c. If `shouldChallenge: true` and no captchaToken yet:
        - Set `showCaptcha(true)`
        - Load Turnstile script dynamically if not already loaded
        - Return early (don't submit) — user needs to complete CAPTCHA first
     d. If rate limit returns 429: show error message ("Trop de soumissions")
     e. Pass fingerprint and captchaToken to the submission mutation
   - Add Turnstile widget conditionally:
     ```tsx
     {showCaptcha && (
       <div className="my-4">
         <div
           className="cf-turnstile"
           data-sitekey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || ''}
           data-callback="onTurnstileSuccess"
           data-theme="dark"
         />
       </div>
     )}
     ```
   - Add script loading for Turnstile when showCaptcha becomes true (useEffect)
   - Add global callback for Turnstile success:
     ```typescript
     useEffect(() => {
       if (showCaptcha) {
         // Define global callback
         (window as any).onTurnstileSuccess = (token: string) => {
           setCaptchaToken(token)
         }
         // Load Turnstile script if not already loaded
         if (!document.querySelector('script[src*="turnstile"]')) {
           const script = document.createElement('script')
           script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js'
           script.async = true
           document.body.appendChild(script)
         }
       }
       return () => { delete (window as any).onTurnstileSuccess }
     }, [showCaptcha])
     ```
   - When captchaToken is set (Turnstile completed), auto-retry the form submission with the token.

3. Update `backend/src/hooks/use-signature-submission.ts`:
   - Add `deviceFingerprint` and `captchaToken` to SubmissionData interface:
     ```typescript
     interface SubmissionData {
       formData: ParticipantFormData
       signatureBlob: Blob
       sessionId: string
       deviceFingerprint?: string
       captchaToken?: string
     }
     ```
   - Pass these to the API calls. The `createParticipant` and `createSignature` calls should include `deviceFingerprint` and `captchaToken` in the request body (or as headers).

4. Update `backend/src/lib/api.ts`:
   - Update `createParticipant` to accept and forward `deviceFingerprint` and `captchaToken` as part of the request body (or as custom headers `X-Device-Fingerprint` and `X-Captcha-Token`)
   - Using headers is cleaner (keeps domain data separate from security metadata):
     ```typescript
     export async function createParticipant(data: Record<string, unknown>, securityHeaders?: { fingerprint?: string, captchaToken?: string }) {
       const headers: Record<string, string> = { 'Content-Type': 'application/json' }
       const csrfToken = getCsrfToken()
       if (csrfToken) headers['X-CSRF-Token'] = csrfToken
       if (securityHeaders?.fingerprint) headers['X-Device-Fingerprint'] = securityHeaders.fingerprint
       if (securityHeaders?.captchaToken) headers['X-Captcha-Token'] = securityHeaders.captchaToken
       // ... rest of function
     }
     ```

IMPORTANT: If `NEXT_PUBLIC_TURNSTILE_SITE_KEY` is not set (dev environment), skip the CAPTCHA flow entirely. The rate limiter and fingerprinting still function, but without CAPTCHA as the second defense layer.

IMPORTANT: The Turnstile widget must match the theme of the signing page. Use `data-theme="dark"` since the public pages use dark mode. If the ThemeProvider supports light mode, read the current theme and pass it to Turnstile.
  </action>
  <verify>
- Fingerprint utility exists: `ls backend/src/lib/security/fingerprint.ts`
- SignPage has CAPTCHA integration: `grep -n "turnstile\|showCaptcha\|captchaToken\|getFingerprint" backend/src/views/SignPage.tsx`
- Submission hook accepts fingerprint: `grep -n "deviceFingerprint\|captchaToken" backend/src/hooks/use-signature-submission.ts`
- API passes security headers: `grep -n "X-Device-Fingerprint\|X-Captcha-Token\|fingerprint" backend/src/lib/api.ts`
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>Public signing flow collects device fingerprint, checks rate limit, shows dynamic CAPTCHA when needed, and passes security tokens to the server</done>
</task>

</tasks>

<verification>
- `cd /workspace/backend && npx tsc --noEmit` passes without errors
- Device fingerprint collected client-side via FingerprintJS
- Rate limiter uses device fingerprint (not IP)
- Rate limiter triggers CAPTCHA after 10 requests/min from same device
- Hard block after 20 requests/min from same device
- Turnstile CAPTCHA loads dynamically only when triggered
- CAPTCHA token verified server-side via Turnstile API
- Normal users never see CAPTCHA (invisible/managed mode)
- Dev environment works without Turnstile keys (graceful fallback)
</verification>

<success_criteria>
- Device fingerprinting active on public signing page
- Rate limiting protects against automated submissions
- CAPTCHA only appears when rate limit threshold exceeded
- Normal signing flow is frictionless (no CAPTCHA for typical use)
- Server-side verification of CAPTCHA tokens
- Graceful degradation when Turnstile not configured (dev)
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-access/08-06-SUMMARY.md`
</output>
