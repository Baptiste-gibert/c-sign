---
phase: 08-security-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/collections/Users.ts
  - backend/src/lib/security/validators.ts
  - backend/payload.config.ts
autonomous: true

must_haves:
  truths:
    - "Organizer session expires after 24 hours requiring re-login"
    - "Account locks after 5 failed login attempts with no auto-unlock"
    - "New passwords must be 8+ chars with mixed case and at least one number"
    - "Organizer role cannot access Payload admin panel (/admin)"
    - "GraphQL playground and API explorer are disabled in production"
  artifacts:
    - path: "backend/src/collections/Users.ts"
      provides: "Auth hardening config (session, lockout, cookies, admin restriction)"
      contains: "maxLoginAttempts"
    - path: "backend/src/lib/security/validators.ts"
      provides: "Password policy validation"
      contains: "passwordSchema"
    - path: "backend/payload.config.ts"
      provides: "Production security flags"
      contains: "graphQL"
  key_links:
    - from: "backend/src/lib/security/validators.ts"
      to: "backend/src/collections/Users.ts"
      via: "beforeChange hook import"
      pattern: "validatePassword"
    - from: "backend/src/collections/Users.ts"
      to: "Payload auth system"
      via: "auth config object"
      pattern: "maxLoginAttempts.*5"
---

<objective>
Harden authentication, password policy, and production configuration for the Users collection and Payload config.

Purpose: Prevent brute-force attacks, enforce password strength, restrict admin panel to admin role only, and disable development features in production.
Output: Hardened Users.ts auth config, password validator, production-safe payload.config.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-security-access/08-RESEARCH.md
@backend/src/collections/Users.ts
@backend/payload.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Password validator and Users auth hardening</name>
  <files>backend/src/lib/security/validators.ts, backend/src/collections/Users.ts</files>
  <action>
1. Create `backend/src/lib/security/validators.ts`:
   - Export a `passwordSchema` Zod schema: min 8 chars, at least one lowercase (`/(?=.*[a-z])/`), at least one uppercase (`/(?=.*[A-Z])/`), at least one digit (`/(?=.*\d)/`). Error messages in French.
   - Export a `validatePassword` beforeChange hook function that validates `data.password` against `passwordSchema` on `create` operations and on `update` when `data.password` is present. On validation failure, throw an Error with joined Zod error messages. Return `data` on success.

2. Update `backend/src/collections/Users.ts`:
   - Import `validatePassword` from `@/lib/security/validators`
   - Replace `auth: true` with a full auth config object:
     ```
     auth: {
       tokenExpiration: 86400,      // 24 hours in seconds
       maxLoginAttempts: 5,
       lockTime: 0,                 // 0 = indefinite lock (admin-only unlock per user decision)
       cookies: {
         secure: process.env.NODE_ENV === 'production',  // HTTPS-only in prod, allow HTTP in dev
         sameSite: 'Strict',
       },
     }
     ```
   - Change `access.admin` from `user?.role === 'admin' || user?.role === 'organizer'` to ONLY `user?.role === 'admin'` (per locked user decision: organizers use frontend only)
   - Add `hooks.beforeChange: [validatePassword]` to Users collection

Note: Do NOT set `forgotPassword: false` or `verify: false` unless Payload 3.x auth config explicitly supports these fields. Check Payload types. If the type does not include these properties, omit them. The user decision says no self-service reset, but Payload may not expose these config options.

Note: `cookies.secure` must be conditional on NODE_ENV to avoid breaking local development (localhost is HTTP, not HTTPS).
  </action>
  <verify>
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
- Grep confirms auth config: `grep -n "maxLoginAttempts\|lockTime\|tokenExpiration\|sameSite" backend/src/collections/Users.ts`
- Grep confirms admin-only access: `grep -n "admin.*role.*admin" backend/src/collections/Users.ts` (should NOT contain "organizer")
- Grep confirms password hook: `grep -n "validatePassword" backend/src/collections/Users.ts`
  </verify>
  <done>Users collection has 24h token expiry, 5-attempt lockout with indefinite lock, Strict/Secure cookies, admin-only panel access, and password policy validation hook</done>
</task>

<task type="auto">
  <name>Task 2: Production configuration flags</name>
  <files>backend/payload.config.ts</files>
  <action>
1. Find the Payload config file. It is at `backend/payload.config.ts` OR `backend/src/payload.config.ts` (check both).

2. Add production security flags to the Payload config:
   - Add `graphQL` config to disable introspection in production:
     ```typescript
     graphQL: {
       disable: process.env.NODE_ENV === 'production',
     }
     ```
     Note: If Payload 3.x does not support `graphQL.disable`, use `graphQL: false` or check the Payload types for the correct property name. The goal is to disable GraphQL playground/introspection in production.

   - Check if there is an `admin` config section. If it exists, ensure no `meta.titleSuffix` or other settings leak internal info. The admin panel itself is already restricted by Users.access.admin (Task 1).

3. If the Payload config does not exist at the expected path, search for it:
   ```
   find backend/ -name "payload.config.ts" -o -name "payload.config.js"
   ```

Important: Do NOT modify the database adapter, collections array, or other functional config. Only add security-related flags.
  </action>
  <verify>
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
- Grep confirms graphQL config: `grep -rn "graphQL\|graphql" backend/payload.config.ts backend/src/payload.config.ts 2>/dev/null`
  </verify>
  <done>GraphQL playground disabled in production, Payload config contains production security flags</done>
</task>

</tasks>

<verification>
- `cd /workspace/backend && npx tsc --noEmit` passes without errors
- Users.ts contains: tokenExpiration: 86400, maxLoginAttempts: 5, lockTime: 0, cookies.sameSite: 'Strict'
- Users.ts access.admin only allows admin role (not organizer)
- Password validator enforces 8+ chars, mixed case, digit requirement
- payload.config.ts disables GraphQL in production
</verification>

<success_criteria>
- Auth hardening config applied with correct values per user decisions
- Password policy enforced via beforeChange hook
- Admin panel restricted to admin role only
- Production features disabled
- All TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-access/08-01-SUMMARY.md`
</output>
