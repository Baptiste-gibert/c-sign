---
phase: 08-security-access
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/lib/security/sanitize.ts
  - backend/src/collections/Participants.ts
  - backend/src/collections/Media.ts
autonomous: true

must_haves:
  truths:
    - "HTML/script tags are stripped from participant text inputs before storage"
    - "Uploaded images are validated by magic bytes (not just MIME type)"
    - "Only PNG and JPEG files are accepted for upload"
    - "Uploaded files are rejected if over 2MB"
    - "Signature images are re-encoded through Sharp to strip metadata and destroy polyglot payloads"
  artifacts:
    - path: "backend/src/lib/security/sanitize.ts"
      provides: "HTML sanitization utility and Payload hook"
      exports: ["sanitizeText", "sanitizeParticipantInput"]
    - path: "backend/src/collections/Participants.ts"
      provides: "Sanitization hook on text inputs"
      contains: "sanitizeParticipantInput"
    - path: "backend/src/collections/Media.ts"
      provides: "Upload validation and re-encoding hooks"
      contains: "beforeChange"
  key_links:
    - from: "backend/src/lib/security/sanitize.ts"
      to: "backend/src/collections/Participants.ts"
      via: "beforeChange hook import"
      pattern: "sanitizeParticipantInput"
    - from: "backend/src/collections/Media.ts"
      to: "sharp"
      via: "image re-encoding in hook"
      pattern: "sharp\\("
---

<objective>
Add server-side input sanitization for participant text fields and upload safety for media files.

Purpose: Defense-in-depth against stored XSS via participant input and polyglot file attacks via image uploads. Validates file types by magic bytes, enforces 2MB size limit, and re-encodes images through Sharp.
Output: Sanitization utilities, hardened Participants and Media collections with security hooks
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-security-access/08-RESEARCH.md
@backend/src/collections/Participants.ts
@backend/src/collections/Media.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install security packages and create sanitization utilities</name>
  <files>backend/src/lib/security/sanitize.ts</files>
  <action>
1. Install required packages:
   ```bash
   cd /workspace/backend && npm install isomorphic-dompurify file-type
   ```
   Note: `sharp` is already installed. `file-type` v19+ is ESM-only — verify it works in the Next.js/Node.js environment. If ESM import fails, use `file-type@16` (last CJS version) as fallback.

2. Create `backend/src/lib/security/sanitize.ts`:
   - Import `DOMPurify` from `isomorphic-dompurify`
   - Export `sanitizeText(input: string): string` — strips ALL HTML tags using `DOMPurify.sanitize(input, { ALLOWED_TAGS: [], KEEP_CONTENT: true, ALLOW_DATA_ATTR: false })`
   - Export `sanitizeParticipantInput` as a Payload `beforeChange` hook:
     - Iterate over fields: `firstName`, `lastName`, `city`, `professionalNumber`, `beneficiaryTypeOther`
     - For each field: if `data[field]` exists and is a string, replace with `sanitizeText(data[field])`
     - Return `data`
     - Type the hook properly using Payload's `CollectionBeforeChangeHook` type (or use inline `{ data, operation }` typing)
  </action>
  <verify>
- File exists: `ls backend/src/lib/security/sanitize.ts`
- Exports correct functions: `grep -n "export.*sanitizeText\|export.*sanitizeParticipantInput" backend/src/lib/security/sanitize.ts`
- Packages installed: `grep "isomorphic-dompurify\|file-type" backend/package.json`
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>sanitize.ts exports sanitizeText and sanitizeParticipantInput, both isomorphic-dompurify and file-type are installed</done>
</task>

<task type="auto">
  <name>Task 2: Harden Participants and Media collections with security hooks</name>
  <files>backend/src/collections/Participants.ts, backend/src/collections/Media.ts</files>
  <action>
1. Update `backend/src/collections/Participants.ts`:
   - Import `sanitizeParticipantInput` from `@/lib/security/sanitize`
   - Add `hooks: { beforeChange: [sanitizeParticipantInput] }` to the collection config
   - Keep ALL existing access control and fields unchanged

2. Update `backend/src/collections/Media.ts`:
   - Add a `beforeChange` hook that performs upload safety checks:
     a. Only run on `create` operation (not updates to alt text)
     b. Access the uploaded file from `req.file` (Payload 3.x provides the file on the request object for upload collections). Console.log the structure if needed during dev to understand the exact shape.
     c. **Magic byte validation**: Import `fileTypeFromBuffer` from `file-type`. Read the file buffer and validate magic bytes. Only allow `image/png` and `image/jpeg`. Throw a French error if invalid: `'Type de fichier non autorise. Seuls PNG et JPEG sont acceptes.'`
     d. **Size validation**: Check buffer length against 2MB (2 * 1024 * 1024). Throw French error if exceeded: `'La taille du fichier ne doit pas depasser 2 Mo'`
     e. **Sharp re-encoding**: Import `sharp`. Re-encode the buffer through Sharp to strip metadata and destroy polyglot payloads:
        ```typescript
        const reEncoded = await sharp(buffer).png({ compressionLevel: 9 }).toBuffer()
        ```
        Replace the original file data with the re-encoded buffer. The exact mechanism depends on Payload's upload hook API — the file may be on `req.file.data` (Buffer) or `req.file` (File object). Adapt accordingly.
     f. If Sharp throws (malformed image), throw: `'Fichier image invalide ou corrompu'`

   - Update `upload.mimeTypes` to remove `image/webp` — only allow `['image/png', 'image/jpeg']` per user decision (PNG/JPEG only)
   - Keep ALL existing access control and fields unchanged

IMPORTANT: Payload 3.x upload hook API may differ from patterns in research. The hook receives `({ data, req, operation, originalDoc })`. The uploaded file is typically on `req.file` with properties like `data` (Buffer), `mimetype`, `name`, `size`. If the exact structure is unclear, add a temporary `console.log('req.file:', JSON.stringify(req.file ? Object.keys(req.file) : 'no file'))` to diagnose, then remove it.

IMPORTANT: The Sharp re-encoding replaces the file buffer BEFORE Payload processes the upload (stores to disk or Vercel Blob). This means modifying `req.file.data` with the re-encoded buffer should work. If `req.file.data` is not writable, try creating a new file object.
  </action>
  <verify>
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
- Participants has sanitization hook: `grep -n "sanitizeParticipantInput\|beforeChange" backend/src/collections/Participants.ts`
- Media has security hooks: `grep -n "beforeChange\|sharp\|fileType\|file-type" backend/src/collections/Media.ts`
- Media only allows PNG/JPEG: `grep -n "mimeTypes" backend/src/collections/Media.ts` (should NOT contain webp)
- Start the dev server briefly to verify no runtime errors: `cd /workspace/backend && timeout 15 npm run dev 2>&1 | tail -20` (look for compilation errors, not full startup)
  </verify>
  <done>Participants collection sanitizes text inputs before storage. Media collection validates magic bytes, enforces 2MB limit, re-encodes through Sharp, and only accepts PNG/JPEG.</done>
</task>

</tasks>

<verification>
- `cd /workspace/backend && npx tsc --noEmit` passes without errors
- Participants.ts has sanitizeParticipantInput in beforeChange hooks
- Media.ts validates magic bytes, enforces 2MB limit, re-encodes via Sharp
- Media.ts mimeTypes only includes PNG and JPEG (no webp)
- isomorphic-dompurify and file-type are in package.json dependencies
</verification>

<success_criteria>
- HTML tags stripped from all participant text fields server-side
- File uploads validated by magic bytes (not just MIME type)
- Only PNG/JPEG accepted
- Files over 2MB rejected
- Images re-encoded through Sharp to strip metadata and destroy polyglot payloads
- All TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-access/08-02-SUMMARY.md`
</output>
