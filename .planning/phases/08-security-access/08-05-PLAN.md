---
phase: 08-security-access
plan: 05
type: execute
wave: 2
depends_on: ["08-04"]
files_modified:
  - backend/src/app/(frontend)/sign/[token]/page.tsx
  - backend/src/views/SignPage.tsx
  - backend/src/lib/api.ts
  - backend/src/views/EventDetailPage.tsx
  - backend/src/components/AttendanceDashboard.tsx
  - backend/src/hooks/use-events.ts
autonomous: true

must_haves:
  truths:
    - "Public signing URL uses unguessable token (not sequential dayId)"
    - "Signing page loads event data by signingToken"
    - "Token validity is tied to event lifecycle (only open/reopened events accessible)"
    - "QR codes and share URLs in organizer UI use signingToken"
    - "Organizer can regenerate signing token from event detail page"
  artifacts:
    - path: "backend/src/app/(frontend)/sign/[token]/page.tsx"
      provides: "New route for token-based signing"
      contains: "token"
    - path: "backend/src/views/SignPage.tsx"
      provides: "Updated SignPage loading data by token"
      contains: "signingToken"
    - path: "backend/src/lib/api.ts"
      provides: "API function to fetch event by signing token"
      exports: ["fetchEventByToken"]
    - path: "backend/src/views/EventDetailPage.tsx"
      provides: "Regenerate token button and updated share URLs"
      contains: "regenerateToken"
  key_links:
    - from: "backend/src/app/(frontend)/sign/[token]/page.tsx"
      to: "backend/src/views/SignPage.tsx"
      via: "renders SignPage component"
      pattern: "SignPage"
    - from: "backend/src/views/SignPage.tsx"
      to: "backend/src/lib/api.ts"
      via: "fetchEventByToken call"
      pattern: "fetchEventByToken"
    - from: "backend/src/views/EventDetailPage.tsx"
      to: "Regenerate token API"
      via: "POST to regenerate-token endpoint"
      pattern: "regenerate"
---

<objective>
Migrate the public signing URL from `/sign/[dayId]` to `/sign/[token]` and update all frontend references.

Purpose: Complete the signing token migration by updating the frontend route, SignPage data loading, and all URL references in the organizer UI. Add token regeneration capability for compromised links.
Output: New token-based route, updated SignPage, updated organizer UI with token URLs and regeneration button
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-security-access/08-RESEARCH.md
@.planning/phases/08-security-access/08-04-SUMMARY.md
@backend/src/app/(frontend)/sign/[dayId]/page.tsx
@backend/src/views/SignPage.tsx
@backend/src/lib/api.ts
@backend/src/views/EventDetailPage.tsx
@backend/src/components/AttendanceDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: New token-based signing route and SignPage migration</name>
  <files>backend/src/app/(frontend)/sign/[token]/page.tsx, backend/src/views/SignPage.tsx, backend/src/lib/api.ts</files>
  <action>
1. Add API function to `backend/src/lib/api.ts`:
   - Add `fetchEventByToken(token: string)` that queries the Payload API:
     ```typescript
     export async function fetchEventByToken(token: string) {
       const res = await fetch(`${API_BASE}/events?where[signingToken][equals]=${token}&depth=1&limit=1`)
       if (!res.ok) throw new Error('Evenement introuvable')
       const data = await res.json()
       if (!data.docs || data.docs.length === 0) throw new Error('Lien de signature invalide ou expire')
       return data.docs[0]
     }
     ```
   - This returns the full event with populated attendanceDays (depth=1)

2. Create `backend/src/app/(frontend)/sign/[token]/page.tsx`:
   ```typescript
   'use client'
   import { SignPage } from '@/views/SignPage'
   export default function Sign() {
     return <SignPage />
   }
   ```

3. Delete or redirect the old route `backend/src/app/(frontend)/sign/[dayId]/page.tsx`:
   - OPTION A (clean): Delete the old `[dayId]` route entirely. If someone has an old URL, it will 404.
   - OPTION B (graceful): Keep `[dayId]/page.tsx` but show a redirect or "link expired" message.
   - Choose OPTION A (clean delete) — old URLs should not work per the security model (sequential IDs are the vulnerability being fixed).

4. Rewrite `backend/src/views/SignPage.tsx`:
   - Change from `useParams<{ dayId: string }>()` to `useParams<{ token: string }>()`
   - Instead of loading by dayId, load by token:
     a. Call `fetchEventByToken(token)` to get the event
     b. Check event status — if not 'open' or 'reopened', show appropriate message (finalized, draft)
     c. Get attendance days from the event's `attendanceDays` relationship (populated at depth=1)
     d. If the URL has a `?day=` query param, use that specific day. Otherwise, if the event has only one day, auto-select it. If multiple days, show a day selector.
     e. Once a day is selected, load sessions for that day (existing `fetchSessionsByDay` function)
     f. The rest of the form logic (session selection, form submission) stays the same
   - The theme loading stays the same (from event.theme)
   - Keep ALL existing UI structure, translations, and styling

   KEY CHANGE in data flow:
   - OLD: URL has dayId -> fetch day -> get event from day -> check status -> load sessions
   - NEW: URL has token -> fetch event by token -> check status -> show days -> select day -> load sessions

   The SignPage now needs a day selection step when the event has multiple attendance days. Show a simple radio/button list of dates when there are multiple days. Auto-select when there's only one day.

5. Keep `fetchAttendanceDay` and `fetchSessionsByDay` in api.ts — they are still needed for loading sessions once a day is selected.
  </action>
  <verify>
- New route exists: `ls backend/src/app/(frontend)/sign/[token]/page.tsx`
- Old route removed: `ls backend/src/app/(frontend)/sign/[dayId]/page.tsx 2>&1` (should fail/not exist)
- SignPage uses token: `grep -n "token\|signingToken\|fetchEventByToken" backend/src/views/SignPage.tsx`
- API function exists: `grep -n "fetchEventByToken" backend/src/lib/api.ts`
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>Public signing URL uses unguessable token, SignPage loads event by token with day selection for multi-day events, old dayId route removed</done>
</task>

<task type="auto">
  <name>Task 2: Update organizer UI URLs and add token regeneration</name>
  <files>backend/src/views/EventDetailPage.tsx, backend/src/components/AttendanceDashboard.tsx, backend/src/hooks/use-events.ts</files>
  <action>
1. Update `backend/src/views/EventDetailPage.tsx`:
   - Find all occurrences of `/sign/${day.id}` and replace with `/sign/${event.signingToken}?day=${day.id}`:
     The signing URL now uses the event's signingToken as the route parameter, with the specific dayId as a query parameter.
   - Update the copy-to-clipboard and displayed URLs to use the token format
   - Add a "Regenerer le lien" (Regenerate link) button in the QR/sharing section:
     - Only visible when event is open or reopened (not draft/finalized)
     - onClick: calls the regenerate-token API endpoint (POST `/api/events/${event.id}/regenerate-token`)
     - Shows a confirmation dialog before regenerating (French: "Regenerer le lien invalidera l'ancien QR code. Continuer?")
     - After success: refresh event data (invalidate TanStack Query cache) to show new token in URLs
     - Style: secondary/warning button with a refresh icon from Lucide

2. Update `backend/src/components/AttendanceDashboard.tsx`:
   - Find all occurrences of `/sign/${day.id}` and replace with `/sign/${event.signingToken}?day=${day.id}`
   - The event object should already be available in this component (it receives event data from parent). If `signingToken` is not currently passed, add it to the props or data flow.

3. Update `backend/src/hooks/use-events.ts`:
   - Add a `useRegenerateToken` mutation hook:
     ```typescript
     export function useRegenerateToken() {
       const queryClient = useQueryClient()
       return useMutation({
         mutationFn: async (eventId: string) => {
           const res = await apiFetch(`/api/events/${eventId}/regenerate-token`, { method: 'POST' })
           return res.json()
         },
         onSuccess: () => {
           queryClient.invalidateQueries({ queryKey: ['events'] })
         },
       })
     }
     ```
   - Import `apiFetch` from `@/lib/api-fetch` (organizer API calls use the authenticated fetch)

4. Add translations for regeneration UI:
   - In the organizer i18n namespace, add keys for:
     - `regenerateLink`: "Regenerer le lien" / "Regenerate link"
     - `regenerateLinkConfirm`: "Regenerer le lien invalidera l'ancien QR code. Continuer?" / "Regenerating the link will invalidate the old QR code. Continue?"
     - `linkRegenerated`: "Lien regenere avec succes" / "Link regenerated successfully"
   - Find the translation JSON files and add these keys.
  </action>
  <verify>
- No old `/sign/${day.id}` patterns without token: `grep -rn "\/sign\/\${day" backend/src/views/EventDetailPage.tsx backend/src/components/AttendanceDashboard.tsx` (should all include signingToken or token)
- Regenerate hook exists: `grep -n "useRegenerateToken\|regenerate-token" backend/src/hooks/use-events.ts`
- Regenerate button in EventDetailPage: `grep -n "regenerate\|Regenerer" backend/src/views/EventDetailPage.tsx`
- TypeScript compiles: `cd /workspace/backend && npx tsc --noEmit --pretty 2>&1 | head -50`
  </verify>
  <done>All organizer UI shows token-based signing URLs, regeneration button available with confirmation dialog, TanStack Query cache invalidated on regeneration</done>
</task>

</tasks>

<verification>
- `cd /workspace/backend && npx tsc --noEmit` passes without errors
- Signing URL format is `/sign/{token}` everywhere (no `/sign/{dayId}` remains)
- Token-based signing page loads event and validates lifecycle status
- Multi-day events show day selection in signing page
- Organizer can regenerate token with confirmation
- All existing functionality preserved (session selection, form submission, theme)
</verification>

<success_criteria>
- Public signing pages are only accessible via unguessable token URLs
- Token validity tied to event lifecycle (open/reopened only)
- Organizer can regenerate tokens to invalidate compromised links
- All QR codes and share URLs in organizer UI updated
- Signing page handles multi-day events with day selection
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-security-access/08-05-SUMMARY.md`
</output>
