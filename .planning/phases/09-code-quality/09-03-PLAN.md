---
phase: 09-code-quality
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - backend/package.json
  - backend/.depcheckrc
  - backend/.husky/pre-commit
autonomous: true

must_haves:
  truths:
    - "depcheck reports no genuinely unused dependencies"
    - "Unused dependencies are removed from package.json"
    - "Pre-commit hook runs lint-staged on git commit"
    - "lint-staged runs ESLint --fix and Prettier --write on staged .ts/.tsx files"
  artifacts:
    - path: "backend/.depcheckrc"
      provides: "Depcheck ignore configuration for false positives"
      contains: "@payloadcms"
    - path: "backend/.husky/pre-commit"
      provides: "Git pre-commit hook running lint-staged"
      contains: "lint-staged"
    - path: "backend/package.json"
      provides: "lint-staged config and cleaned dependencies"
      contains: "lint-staged"
  key_links:
    - from: "backend/.husky/pre-commit"
      to: "backend/package.json"
      via: "lint-staged config in package.json"
      pattern: "lint-staged"
---

<objective>
Audit dependencies with depcheck and remove unused packages, then set up husky + lint-staged for pre-commit enforcement of code quality rules.

Purpose: Clean up unused dependencies from 8 rapid phases of development, and ensure the "zero errors" standard is maintained going forward via pre-commit hooks.
Output: Clean package.json with unused deps removed, working pre-commit hook that enforces linting and formatting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-code-quality/09-RESEARCH.md
@.planning/phases/09-code-quality/09-01-SUMMARY.md
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and remove unused dependencies</name>
  <files>
    backend/.depcheckrc
    backend/package.json
  </files>
  <action>
1. Create `backend/.depcheckrc` to ignore known false positives:
```json
{
  "ignores": [
    "@payloadcms/*",
    "@types/*",
    "sharp",
    "cross-env",
    "tsx",
    "graphql",
    "eslint",
    "typescript",
    "eslint-config-next",
    "eslint-config-prettier",
    "eslint-plugin-simple-import-sort",
    "typescript-eslint",
    "@eslint/js",
    "husky",
    "lint-staged",
    "depcheck",
    "@tailwindcss/postcss"
  ],
  "ignore-patterns": [
    "dist",
    "build",
    ".next",
    "node_modules"
  ]
}
```

NOTE: The ignores list includes:
- `@payloadcms/*` — used via Payload config, not direct imports
- `@types/*` — TypeScript compiler uses these, not runtime
- `sharp` — Next.js image optimization auto-detects it
- `cross-env` — used in package.json scripts, not source code
- `tsx` — used as CLI tool, not imported
- `graphql` — Payload CMS peer dependency
- ESLint-related packages — used in config files, not source imports
- `@tailwindcss/postcss` — used in Next.js config

2. Run depcheck and analyze output:
```bash
cd /workspace/backend && npx depcheck
```

3. For each flagged dependency, verify whether it's genuinely unused:
- Check if it appears in any source file: `grep -r "package-name" src/`
- Check if it appears in config files: `grep -r "package-name" *.config.* payload.config.ts`
- Check if it's a peer dependency of another package: `npm ls package-name`
- Check if it's used in docker-compose.yml or Dockerfile

4. Remove genuinely unused dependencies:
```bash
cd /workspace/backend && npm uninstall <unused-package-1> <unused-package-2> ...
```

IMPORTANT: Do NOT remove packages that are:
- Listed in .depcheckrc ignores (already filtered)
- Used as Payload CMS plugins (check payload.config.ts)
- Used in build scripts or CI
- Peer dependencies required by other packages

Likely candidates for removal based on the dependency list — verify each before removing:
- `@edge-csrf/nextjs` — check if still used after Phase 8 CSRF implementation (research notes mention it was deprecated and replaced with double-submit cookie pattern)
- `react-router-dom` — check if still used (Next.js App Router may have replaced it)
- `radix-ui` — check if used directly or only via shadcn/ui components

5. After removal, verify the app still builds:
```bash
cd /workspace/backend && npm run type-check
```

6. Record what was removed and why in the summary.
  </action>
  <verify>
Run: `cd /workspace/backend && npx depcheck` — should report minimal or zero unused dependencies (only false positives covered by .depcheckrc).
Run: `cd /workspace/backend && npm run type-check` — must exit 0 after removing packages.
  </verify>
  <done>depcheck reports clean (only ignored false positives). All genuinely unused dependencies removed from package.json. TypeScript still compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Set up husky + lint-staged pre-commit hooks</name>
  <files>
    backend/.husky/pre-commit
    backend/package.json
  </files>
  <action>
1. Initialize husky in the backend directory:
```bash
cd /workspace/backend && npx husky init
```

This creates `.husky/` directory and a default pre-commit hook.

2. Add lint-staged configuration to `backend/package.json`:
```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,css}": [
      "prettier --write"
    ]
  }
}
```

3. Update `.husky/pre-commit` to run lint-staged:
```bash
npx lint-staged
```

NOTE: husky 9.x uses simple scripts, NOT the old `husky.sh` sourcing pattern. The pre-commit file should contain just the command.

4. Add a `prepare` script to package.json if husky init didn't add it:
```json
{
  "scripts": {
    "prepare": "husky"
  }
}
```

5. Test the pre-commit hook by making a small change and committing:
```bash
cd /workspace/backend
echo "// test" >> src/payload.config.ts
git add src/payload.config.ts
git commit -m "test: verify pre-commit hook" --no-gpg-sign 2>&1 | head -20
```

If lint-staged runs and catches the comment, the hook works. Then revert:
```bash
cd /workspace/backend
git reset HEAD~1
git checkout src/payload.config.ts
```

If the commit was blocked by lint-staged (expected — the test comment would be removed by Prettier), that proves the hook works. Clean up the file.

6. Verify the hook file is executable:
```bash
chmod +x /workspace/backend/.husky/pre-commit
```
  </action>
  <verify>
Run: `ls -la /workspace/backend/.husky/pre-commit` — file exists and is executable.
Run: `cat /workspace/backend/.husky/pre-commit` — contains `npx lint-staged`.
Run: `grep "lint-staged" /workspace/backend/package.json` — lint-staged config exists.
Run: `grep "prepare" /workspace/backend/package.json` — prepare script exists.
  </verify>
  <done>Pre-commit hook is installed and runs lint-staged. lint-staged runs ESLint --fix and Prettier --write on staged TypeScript files. The "zero errors" standard is enforced on every commit.</done>
</task>

</tasks>

<verification>
1. `cd /workspace/backend && npx depcheck` reports clean or only known false positives
2. `cd /workspace/backend && npm run type-check` exits 0 after dependency cleanup
3. Pre-commit hook file exists at `backend/.husky/pre-commit` with lint-staged command
4. `lint-staged` config in package.json targets .ts/.tsx and .json/.css files
5. `npm run quality` still exits 0 (confirming no regressions from dependency removal)
</verification>

<success_criteria>
- All genuinely unused dependencies removed from package.json
- depcheck reports clean with .depcheckrc filtering false positives
- husky pre-commit hook runs lint-staged on every commit
- lint-staged applies ESLint --fix and Prettier --write to staged files
- Application still compiles and all quality checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-code-quality/09-03-SUMMARY.md`
</output>
