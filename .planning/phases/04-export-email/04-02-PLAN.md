---
phase: 04-export-email
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/hooks/use-export.ts
  - frontend/src/pages/EventDetailPage.tsx
autonomous: false

must_haves:
  truths:
    - "Organizer sees Download XLSX button on finalized event detail page"
    - "Clicking Download triggers file download with correct filename"
    - "Download button shows loading state during generation"
    - "Download button is hidden for non-finalized events"
    - "Finalize action on event detail page still works and triggers backend export"
  artifacts:
    - path: "frontend/src/hooks/use-export.ts"
      provides: "TanStack Query mutation for downloading XLSX export"
      exports: ["useDownloadExport"]
    - path: "frontend/src/pages/EventDetailPage.tsx"
      provides: "Updated event detail with download button for finalized events"
      contains: "useDownloadExport"
  key_links:
    - from: "frontend/src/hooks/use-export.ts"
      to: "/api/events/:id/export"
      via: "fetch with credentials: include"
      pattern: "fetch.*api/events.*export"
    - from: "frontend/src/pages/EventDetailPage.tsx"
      to: "frontend/src/hooks/use-export.ts"
      via: "import useDownloadExport"
      pattern: "useDownloadExport"
---

<objective>
Add frontend download capability and verify the complete export pipeline end-to-end.

Purpose: Organizers need a visible "Download XLSX" button on finalized events to manually retrieve the attendance sheet. This completes the user-facing side of Phase 4 and validates the entire export pipeline works.

Output: 1 new frontend file (use-export hook), 1 modified file (EventDetailPage), then human verification of complete flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-export-email/04-RESEARCH.md
@.planning/phases/04-export-email/04-01-SUMMARY.md

@frontend/src/pages/EventDetailPage.tsx
@frontend/src/hooks/use-events.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create download export hook and add download button to EventDetailPage</name>
  <files>
    frontend/src/hooks/use-export.ts
    frontend/src/pages/EventDetailPage.tsx
  </files>
  <action>
    1. Create `frontend/src/hooks/use-export.ts`:
       - Import `useMutation` from `@tanstack/react-query`
       - Export `useDownloadExport()` returning a TanStack Query mutation
       - mutationFn accepts `eventId: string`:
         - `fetch(`/api/events/${eventId}/export`, { credentials: 'include' })`
         - If response not ok, parse error JSON and throw
         - Extract filename from `Content-Disposition` header (regex match `filename="(.+)"`)
         - Fallback filename: `'export.xlsx'`
         - Convert response to blob via `res.blob()`
         - Create object URL via `window.URL.createObjectURL(blob)`
         - Create temporary `<a>` element, set href and download attribute, click it
         - Revoke object URL and remove element (cleanup)
       - This triggers a browser file download without navigating away from page

    2. Update `frontend/src/pages/EventDetailPage.tsx`:
       - Add import: `import { useDownloadExport } from '@/hooks/use-export'`
       - Add import for `Download` icon from `lucide-react`
       - Inside the component, initialize: `const downloadMutation = useDownloadExport()`
       - Add a download handler: `const handleDownload = () => downloadMutation.mutate(id!)`
       - In the JSX, find the section where status controls are rendered (the area with "Ouvrir" / "Finaliser" buttons)
       - When `event.status === 'finalized'`, render a "Telecharger XLSX" button:
         - Use shadcn `Button` with `variant="outline"`
         - Show `Download` lucide icon + text "Telecharger XLSX"
         - When `downloadMutation.isPending`, show `Loader2` spinner icon + text "Generation..."
         - Disable button while pending
         - onClick calls `handleDownload`
       - If `downloadMutation.isError`, show a small error message below the button: "Echec du telechargement, veuillez reessayer"
       - The download button should appear ALONGSIDE the existing finalized status badge area -- it should be visually clear that this is a completed event with an export available

    IMPORTANT: The download button must only appear when status === 'finalized'. For draft and open events, it should not be visible at all.

    IMPORTANT: Use `credentials: 'include'` on the fetch call -- the backend route requires authentication via HTTP-only cookie.

    IMPORTANT: Do not remove or modify any existing functionality in EventDetailPage (status controls, participant management, QR codes, attendance dashboard). Only ADD the download button in the appropriate location.
  </action>
  <verify>
    Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compilation. Run `cd /workspace/frontend && npx vite build` to verify production build succeeds. Verify use-export.ts exists with useDownloadExport export. Verify EventDetailPage.tsx imports and uses useDownloadExport.
  </verify>
  <done>
    - `useDownloadExport` hook triggers browser file download via blob URL pattern
    - EventDetailPage shows "Telecharger XLSX" button only for finalized events
    - Button shows loading spinner during download generation
    - Error state displayed if download fails
    - All existing EventDetailPage functionality preserved
    - TypeScript compiles and Vite production build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of export and download pipeline</name>
  <files>none (verification only)</files>
  <action>
    Human verification of the complete Phase 4 export pipeline. No code changes -- just testing the end-to-end flow from finalization through XLSX download and inspection.
  </action>
  <verify>
    Prerequisites: Both backend and frontend must be running (`cd /workspace/backend && npm run dev` and `cd /workspace/frontend && npm run dev`).

    1. Open browser to http://localhost:5173 and log in as organizer
    2. Navigate to an existing event that has status "open" and has at least one signed participant (signature exists)
       - If no such event exists: create one, open it, scan QR code on the sign page, submit a signature, then return to the event detail
    3. On the event detail page, click "Finaliser" and confirm
    4. Verify the event status changes to "Finalise"
    5. Verify a "Telecharger XLSX" button appears after finalization
    6. Click "Telecharger XLSX" button
    7. Verify a .xlsx file downloads to your machine
    8. Open the XLSX file in Excel/LibreOffice/Google Sheets
    9. Verify it contains:
       - Event header info (title, location, organizer, expense type) in first rows
       - Column headers: Nom, Prenom, Email, Ville, N inscription, Type beneficiaire, Date, Session, Droit image, Signature
       - Participant data rows with correct information
       - Signature images embedded in the Signature column cells
       - Images are small/optimized (not full-size original)
    10. Check backend terminal for email-related log output (will show email send attempt -- may fail if no SMTP configured, which is expected in dev)

    NOTE: Email delivery will likely fail in development (no SMTP server configured). This is expected. The important verification is that:
    - XLSX generation works correctly
    - Download endpoint works
    - Signature images are embedded in cells
    - File size is reasonable (well under 8MB)
    - The afterFinalize hook attempts to send email (visible in logs)
  </verify>
  <done>
    - XLSX downloads successfully with correct participant data
    - Signature images are visible and embedded in cells
    - File size is under 8MB
    - Backend logs show export generation and email send attempt
    - Human tester approves the output
  </done>
</task>

</tasks>

<verification>
1. `cd /workspace/frontend && npx tsc --noEmit` passes
2. `cd /workspace/frontend && npx vite build` succeeds
3. Download button visible only on finalized events
4. XLSX file downloads with participant data and embedded signature images
5. Backend logs show export generation and email attempt
</verification>

<success_criteria>
- Organizer can download XLSX from finalized event detail page
- XLSX contains participant data with embedded signature images
- Signature images are optimized (200x100px JPEG, not full-size PNG)
- Download button has proper loading and error states
- Email attempt logged on finalization (actual delivery depends on SMTP config)
- Complete flow verified by human tester
</success_criteria>

<output>
After completion, create `.planning/phases/04-export-email/04-02-SUMMARY.md`
</output>
