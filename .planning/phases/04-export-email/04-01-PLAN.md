---
phase: 04-export-email
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/payload.config.ts
  - backend/src/lib/export/generateXLSX.ts
  - backend/src/lib/export/optimizeSignature.ts
  - backend/src/lib/export/types.ts
  - backend/src/lib/email/templates.ts
  - backend/src/hooks/events/afterFinalize.ts
  - backend/src/collections/Events.ts
  - backend/src/app/(payload)/api/events/[id]/export/route.ts
autonomous: true

must_haves:
  truths:
    - "Finalizing an event triggers XLSX generation with embedded signature images"
    - "XLSX contains participant data columns and signature images in cells"
    - "Signature images are optimized to 200x100px JPEG before embedding"
    - "System sends email with XLSX attachment to transparence@ceva.com and organizer email"
    - "Authenticated organizer can download XLSX via GET /api/events/:id/export"
    - "Only finalized events can be exported"
  artifacts:
    - path: "backend/src/lib/export/generateXLSX.ts"
      provides: "XLSX generation with embedded signature images"
      exports: ["generateEventXLSX"]
    - path: "backend/src/lib/export/optimizeSignature.ts"
      provides: "Sharp image optimization pipeline"
      exports: ["optimizeSignature"]
    - path: "backend/src/lib/export/types.ts"
      provides: "TypeScript types for export data"
      exports: ["ExportData"]
    - path: "backend/src/lib/email/templates.ts"
      provides: "HTML email template for finalization notification"
      exports: ["buildFinalizeEmailTemplate"]
    - path: "backend/src/hooks/events/afterFinalize.ts"
      provides: "Hook that triggers export + email on status change to finalized"
      exports: ["afterFinalize"]
    - path: "backend/src/app/(payload)/api/events/[id]/export/route.ts"
      provides: "Manual XLSX download endpoint"
      exports: ["GET"]
  key_links:
    - from: "backend/src/collections/Events.ts"
      to: "backend/src/hooks/events/afterFinalize.ts"
      via: "afterChange hook array"
      pattern: "afterFinalize"
    - from: "backend/src/hooks/events/afterFinalize.ts"
      to: "backend/src/lib/export/generateXLSX.ts"
      via: "import and call generateEventXLSX"
      pattern: "generateEventXLSX"
    - from: "backend/src/lib/export/generateXLSX.ts"
      to: "backend/src/lib/export/optimizeSignature.ts"
      via: "import and call optimizeSignature per image"
      pattern: "optimizeSignature"
    - from: "backend/src/hooks/events/afterFinalize.ts"
      to: "req.payload.sendEmail"
      via: "Payload email API with XLSX attachment"
      pattern: "sendEmail"
    - from: "backend/src/app/(payload)/api/events/[id]/export/route.ts"
      to: "backend/src/lib/export/generateXLSX.ts"
      via: "import and call generateEventXLSX"
      pattern: "generateEventXLSX"
---

<objective>
Build the complete backend export pipeline: XLSX generation with embedded signature images, image optimization, email delivery on finalization, and manual download endpoint.

Purpose: This is the core of Phase 4 -- when an organizer finalizes an event, the system generates a compliance-ready XLSX attendance sheet with embedded signatures, emails it to the transparency team and organizer, and provides a manual download endpoint as fallback.

Output: 7 new backend files (export lib, email template, hook, route handler) + 2 modified files (Events.ts, payload.config.ts)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-export-email/04-RESEARCH.md

@backend/src/collections/Events.ts
@backend/src/hooks/events/afterChange.ts
@backend/src/payload.config.ts
@backend/src/collections/Signatures.ts
@backend/src/collections/Participants.ts
@backend/src/collections/Sessions.ts
@backend/src/collections/AttendanceDays.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create XLSX generation pipeline with image optimization</name>
  <files>
    backend/package.json
    backend/src/lib/export/types.ts
    backend/src/lib/export/optimizeSignature.ts
    backend/src/lib/export/generateXLSX.ts
  </files>
  <action>
    1. Install new backend dependencies:
       ```bash
       cd /workspace/backend && npm install exceljs @payloadcms/email-nodemailer nodemailer && npm install -D @types/nodemailer
       ```

    2. Create `backend/src/lib/export/types.ts` with TypeScript interfaces for export data:
       - `ExportData` interface with event info (title, location, organizerName, expenseType) and attendanceDays array
       - Each attendanceDay has date string and sessions array
       - Each session has name and signatures array
       - Each signature has participant object (lastName, firstName, email, city, professionalNumber, beneficiaryType), image object (url, filename), and rightToImage boolean

    3. Create `backend/src/lib/export/optimizeSignature.ts`:
       - Export `optimizeSignature(inputBuffer: Buffer): Promise<Buffer>`
       - Use Sharp (already installed) to resize to 200x100px with `fit: 'inside'`, `withoutEnlargement: true`
       - Flatten alpha to white background via `.flatten({ background: { r: 255, g: 255, b: 255 } })`
       - Convert to JPEG at quality 80 with `mozjpeg: true`
       - Wrap in try/catch, re-throw with descriptive error message

    4. Create `backend/src/lib/export/generateXLSX.ts`:
       - Export `generateEventXLSX(payload: Payload, eventId: string): Promise<Buffer>`
       - Fetch event with `depth: 3` to populate Event -> AttendanceDays -> Sessions -> Signatures -> Participant + Media
       - Create ExcelJS Workbook with `creator: 'c-sign'`
       - Add worksheet named 'Feuille de Presence'
       - Set 10 columns: Nom (20), Prenom (20), Email (30), Ville (20), N inscription (20), Type beneficiaire (20), Date (15), Session (20), Droit image (15), Signature (30)
       - Add 2 header rows with event info (title, location, organizer, expense type) then empty row
       - Add column header row (row 4) with bold font and gray fill (ARGB FFE0E0E0)
       - Iterate through attendanceDays -> sessions -> signatures:
         - Add data row with participant fields, date formatted as dd/mm/yyyy using Date object + numFmt, session name, rightToImage as "Oui"/"Non"
         - Set row height to 75 for signature image
         - Fetch signature image via internal URL (construct from `process.env.NEXT_PUBLIC_SERVER_URL || 'http://localhost:3000'` + image url)
         - Call `optimizeSignature()` on the buffer
         - Add image to workbook with `extension: 'jpeg'`
         - Place image in signature column using 0-indexed anchor: `tl: { col: 9, row: row.number - 1 }`, `br: { col: 10, row: row.number }`, `editAs: 'oneCell'`
         - Wrap image fetch+optimize+embed in try/catch -- log error and continue without image if any step fails
       - Add autoFilter from A4 to J4
       - Write to buffer via `workbook.xlsx.writeBuffer()`, cast to Buffer, return
       - Log file size in MB after generation
       - If file size > 8MB, log warning about email delivery limits

    IMPORTANT: ExcelJS image anchors are 0-indexed (col/row) while worksheet.addRow returns 1-indexed row numbers. Always use `row.number - 1` for tl anchor and `row.number` for br anchor.

    IMPORTANT: When fetching signature images, the URL from Payload Media may be relative (e.g., `/media/filename.png`). Construct full URL by prepending server base URL. Use `fetch()` with the full URL to get the image buffer.

    IMPORTANT: Handle the case where depth=3 fetch returns IDs instead of populated objects for some relationships. Check if attendanceDays/sessions/signatures are objects (have properties) vs just ID strings, and skip if not populated.
  </action>
  <verify>
    Run `cd /workspace/backend && npx tsc --noEmit` to verify TypeScript compilation passes with no errors. Verify exceljs and nodemailer are in package.json dependencies. Verify all 3 export files exist and have correct exports.
  </verify>
  <done>
    - ExcelJS, @payloadcms/email-nodemailer, and nodemailer installed in backend
    - `optimizeSignature()` resizes to 200x100px JPEG at 80% quality with white background
    - `generateEventXLSX()` produces Buffer containing XLSX with participant rows and embedded signature images
    - Image embedding uses correct 0-indexed anchor coordinates
    - Corrupted/missing images are gracefully skipped (no export failure)
    - TypeScript compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure email adapter, create afterFinalize hook, build download route</name>
  <files>
    backend/src/payload.config.ts
    backend/src/lib/email/templates.ts
    backend/src/hooks/events/afterFinalize.ts
    backend/src/collections/Events.ts
    backend/src/app/(payload)/api/events/[id]/export/route.ts
  </files>
  <action>
    1. Create `backend/src/lib/email/templates.ts`:
       - Export `buildFinalizeEmailTemplate(event: { title: string; organizerName: string; location: string; expenseType: string }): string`
       - Return HTML email with: heading "Evenement finalise", greeting, event details list (organizer, location, expense type), attachment mention, signature "c-sign - Ceva Sante Animale"
       - Use inline CSS (no external stylesheets -- email compatibility)
       - Use simple HTML (no complex layouts -- Outlook compatibility)

    2. Update `backend/src/payload.config.ts`:
       - Import `nodemailerAdapter` from `@payloadcms/email-nodemailer`
       - Add `email` property to buildConfig:
         ```
         email: nodemailerAdapter({
           defaultFromAddress: process.env.SMTP_FROM_EMAIL || 'noreply@ceva.com',
           defaultFromName: 'c-sign - Ceva Sante Animale',
           transportOptions: {
             host: process.env.SMTP_HOST || 'localhost',
             port: parseInt(process.env.SMTP_PORT || '587'),
             secure: process.env.SMTP_PORT === '465',
             auth: process.env.SMTP_USER ? {
               user: process.env.SMTP_USER,
               pass: process.env.SMTP_PASS,
             } : undefined,
           },
         })
         ```
       - The auth is conditional: if SMTP_USER is not set (development), skip auth entirely (allows local testing without SMTP credentials)
       - Keep ALL existing config untouched (collections, editor, secret, typescript, db)

    3. Create `backend/src/hooks/events/afterFinalize.ts`:
       - Export `afterFinalize: CollectionAfterChangeHook`
       - Only trigger when: `operation === 'update'` AND `doc.status === 'finalized'` AND `previousDoc?.status !== 'finalized'`
       - When triggered, call async helper `generateAndEmailExport(req, doc)` WITHOUT await -- fire-and-forget to avoid blocking the HTTP response. Chain `.catch()` to log errors.
       - In `generateAndEmailExport`:
         - Call `generateEventXLSX(req.payload, doc.id)` to get XLSX buffer
         - Log file size in MB
         - Build filename: `feuille-presence-{title-slug}-{yyyy-MM-dd}.xlsx` (replace spaces with dashes in title)
         - Build recipients array: `['transparence@ceva.com', doc.organizerEmail]`
         - Call `req.payload.sendEmail()` with:
           - `to`: recipients joined by comma
           - `subject`: `Feuille de presence - {doc.title}`
           - `html`: from `buildFinalizeEmailTemplate()`
           - `attachments`: array with single object `{ filename, content: xlsxBuffer, contentType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }`
         - Log success message with event ID and recipients
       - Always return doc (don't modify)

    4. Update `backend/src/collections/Events.ts`:
       - Add import: `import { afterFinalize } from '@/hooks/events/afterFinalize'`
       - Change `afterChange: [afterEventChange]` to `afterChange: [afterEventChange, afterFinalize]`
       - No other changes to Events.ts

    5. Create `backend/src/app/(payload)/api/events/[id]/export/route.ts`:
       - Export `GET` handler (Next.js App Router route handler)
       - Accept `req: NextRequest` and destructured params `{ params }: { params: Promise<{ id: string }> }` (Next.js 15 uses async params -- must await)
       - Await params: `const { id } = await params`
       - Get Payload instance via `getPayload({ config: configPromise })` where configPromise is imported from `@payload-config`
       - Authenticate: call Payload auth (use `req.headers` to extract JWT cookie). If no user, return 401.
       - Fetch event by ID with user context for access control
       - If event not found, return 404
       - If event.status !== 'finalized', return 400 with message "Event must be finalized before export"
       - Call `generateEventXLSX(payload, id)` to generate XLSX
       - Build filename same pattern as hook
       - Return `new Response(xlsxBuffer, { status: 200, headers: { 'Content-Type': '...spreadsheetml...', 'Content-Disposition': 'attachment; filename="..."', 'Content-Length': '...' } })`
       - Wrap entire handler in try/catch, return 500 on error

    IMPORTANT for Next.js 15: Route handler params are a Promise and must be awaited. Use `const { id } = await params`.

    IMPORTANT: For Payload auth in route handler, use the pattern from Payload 3.x docs. Import config from `@payload-config` (not relative path). Use `const { user } = await payload.auth({ headers: req.headers })` to authenticate.

    IMPORTANT: The email send is fire-and-forget (no await before returning doc). This prevents blocking the status update response. If email fails, organizer can still manually download.
  </action>
  <verify>
    Run `cd /workspace/backend && npx tsc --noEmit` to verify TypeScript compilation. Verify Events.ts has both afterEventChange and afterFinalize in afterChange array. Verify payload.config.ts has email adapter configured. Verify route handler file exists at correct path.
  </verify>
  <done>
    - payload.config.ts has nodemailerAdapter configured with SMTP env vars
    - Email template generates proper HTML for finalization notification
    - afterFinalize hook triggers on status change to 'finalized' (not on other status changes)
    - Export+email runs in background (fire-and-forget) to avoid blocking response
    - Events.ts afterChange array includes both afterEventChange and afterFinalize
    - Download route at /api/events/[id]/export authenticates user, checks finalized status, returns XLSX with download headers
    - TypeScript compiles with no errors
  </done>
</task>

</tasks>

<verification>
1. `cd /workspace/backend && npx tsc --noEmit` passes
2. `exceljs`, `@payloadcms/email-nodemailer`, `nodemailer` in backend/package.json
3. All 7 new files exist at expected paths
4. Events.ts hooks array includes afterFinalize
5. payload.config.ts includes email adapter
6. Export route handler exists and handles auth + status validation
</verification>

<success_criteria>
- Backend XLSX generation pipeline produces valid Excel files with participant data and embedded signature images
- Image optimization reduces signatures to 200x100px JPEG (from original PNG)
- Email delivery configured via Payload nodemailer adapter
- afterFinalize hook triggers only on open->finalized transition
- Manual download endpoint requires authentication and finalized status
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-export-email/04-01-SUMMARY.md`
</output>
