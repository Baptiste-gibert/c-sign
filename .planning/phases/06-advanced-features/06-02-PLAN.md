---
phase: 06-advanced-features
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/hooks/use-events.ts
  - frontend/src/pages/EventDetailPage.tsx
  - frontend/src/pages/SignPage.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/hooks/use-participants.ts
  - frontend/src/i18n/locales/fr/common.json
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/organizer.json
  - frontend/src/i18n/locales/en/organizer.json
  - frontend/src/i18n/locales/fr/public.json
  - frontend/src/i18n/locales/en/public.json
autonomous: true

must_haves:
  truths:
    - "Organizer sees Reopen button when event status is finalized"
    - "Organizer can click Reopen button to change event status from finalized to reopened"
    - "After reopening, organizer can add walk-in participants and manage participant list"
    - "After reopening, organizer can re-finalize event"
    - "Reopened event status badge shows correct label (Rouvert/Reopened) with distinct color"
    - "Public signing page allows signatures on reopened events (form visible)"
    - "CNOV declaration number is visible on event detail page"
    - "Walk-in participant form resets and closes dialog on success"
    - "All status labels, buttons, and messages are bilingual (FR/EN)"
    - "Organizer can set CNOV declaration number on event via PATCH"
  artifacts:
    - path: "frontend/src/pages/EventDetailPage.tsx"
      provides: "Reopen button, CNOV display, reopened status handling, walk-in UX improvements"
      contains: "reopened"
    - path: "frontend/src/pages/SignPage.tsx"
      provides: "Signing form visible for reopened events"
      contains: "reopened"
    - path: "frontend/src/pages/DashboardPage.tsx"
      provides: "StatusBadge handling for reopened events"
      contains: "reopened"
    - path: "frontend/src/hooks/use-events.ts"
      provides: "PayloadEvent type with reopened status"
      contains: "reopened"
    - path: "frontend/src/i18n/locales/fr/common.json"
      provides: "French translation for reopened status"
      contains: "Rouvert"
    - path: "frontend/src/i18n/locales/en/common.json"
      provides: "English translation for reopened status"
      contains: "Reopened"
  key_links:
    - from: "frontend/src/pages/EventDetailPage.tsx"
      to: "/api/events/:id (PATCH)"
      via: "useUpdateEvent mutation with status: 'reopened'"
      pattern: "handleReopen.*reopened"
    - from: "frontend/src/pages/SignPage.tsx"
      to: "frontend/src/components/ParticipantForm.tsx"
      via: "eventStatus check includes reopened"
      pattern: "status.*===.*open.*||.*reopened"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/i18n/locales/*/common.json"
      via: "StatusBadge renders t('common:status.reopened')"
      pattern: "status\\.reopened"
---

<objective>
Update all frontend components to support the reopened event status, display CNOV metadata, improve walk-in participant UX, and add bilingual translations for all new strings.

Purpose: Complete the user-facing features for Phase 6 — organizers can reopen events, see CNOV numbers, and efficiently manage walk-in participants with better feedback.
Output: Updated EventDetailPage with reopen flow and CNOV display, SignPage supporting reopened events, DashboardPage StatusBadge update, all i18n translations, walk-in UX improvements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-RESEARCH.md
@.planning/phases/06-advanced-features/06-01-SUMMARY.md
@frontend/src/pages/EventDetailPage.tsx
@frontend/src/pages/SignPage.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/src/hooks/use-events.ts
@frontend/src/hooks/use-participants.ts
@frontend/src/i18n/locales/fr/common.json
@frontend/src/i18n/locales/en/common.json
@frontend/src/i18n/locales/fr/organizer.json
@frontend/src/i18n/locales/en/organizer.json
@frontend/src/i18n/locales/fr/public.json
@frontend/src/i18n/locales/en/public.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EventDetailPage with reopen button, CNOV display, and walk-in improvements</name>
  <files>
    frontend/src/pages/EventDetailPage.tsx
    frontend/src/hooks/use-events.ts
    frontend/src/hooks/use-participants.ts
  </files>
  <action>
  **use-events.ts changes:**

  1. Update the `PayloadEvent` interface (line 10) to include "reopened" in the status union type:
     ```typescript
     status: 'draft' | 'open' | 'finalized' | 'reopened'
     ```

  2. Add `cnovDeclarationNumber` to the `PayloadEvent` interface:
     ```typescript
     cnovDeclarationNumber?: string
     ```

  **use-participants.ts changes:**

  3. Add optimistic updates to `useAddWalkIn` (line 140-195). Enhance with `onMutate` for optimistic cache update and `onError` for rollback. Add `onSettled` to refetch:
     ```typescript
     export function useAddWalkIn(eventId: string) {
       const queryClient = useQueryClient()

       return useMutation({
         mutationFn: async (participantData: { ... }) => {
           // ... existing implementation unchanged ...
         },
         onMutate: async (newParticipant) => {
           await queryClient.cancelQueries({ queryKey: ['events', eventId] })
           const previousEvent = queryClient.getQueryData(['events', eventId])
           queryClient.setQueryData(['events', eventId], (old: any) => {
             if (!old) return old
             return {
               ...old,
               participants: [
                 ...(old.participants || []),
                 {
                   id: 'temp-' + Date.now(),
                   ...newParticipant,
                 },
               ],
             }
           })
           return { previousEvent }
         },
         onError: (_err, _newParticipant, context) => {
           if (context?.previousEvent) {
             queryClient.setQueryData(['events', eventId], context.previousEvent)
           }
         },
         onSettled: () => {
           queryClient.invalidateQueries({ queryKey: ['events', eventId] })
         },
       })
     }
     ```
     Remove the existing `onSuccess` that only does invalidation since `onSettled` now handles it.

  **EventDetailPage.tsx changes:**

  4. Add "reopened" to the `statusColors` map (line 40-44):
     ```typescript
     const statusColors: Record<string, string> = {
       draft: 'bg-neutral-200 text-neutral-800',
       open: 'bg-green-100 text-green-800',
       finalized: 'bg-blue-100 text-blue-800',
       reopened: 'bg-amber-100 text-amber-800',
     }
     ```

  5. Update `isFinalized` logic (line 147). Currently `const isFinalized = event.status === 'finalized'`. This variable is used to disable participant management (SIMV search disabled, walk-in button disabled, participant table disabled). When event is reopened, participant management should be RE-ENABLED. Keep `isFinalized` for the finalized-only case, add `isLocked` for UI disabling:
     ```typescript
     const isFinalized = event.status === 'finalized'
     const isLocked = event.status === 'finalized' // Only truly locked when finalized, not when reopened
     ```
     Replace all uses of `isFinalized` as a `disabled` prop with `isLocked`.
     - Line 342: `disabled={isLocked}` (ParticipantSearch)
     - Line 351: `disabled={isLocked}` (walk-in button)
     - Line 461: `isLoading={isLocked}` (ParticipantTable — note: this prop controls whether remove buttons are shown)

  6. Add CNOV display in the event header area. After the expense type Badge (line 185), add CNOV if present:
     ```tsx
     {event.cnovDeclarationNumber && (
       <>
         <span>•</span>
         <span>{t('organizer:eventDetail.cnov')} {event.cnovDeclarationNumber}</span>
       </>
     )}
     ```

  7. Add Reopen button in the status controls section. After the finalized section (lines 252-272), the `{event.status === 'finalized' && (...)}` block currently shows a "finalized" message and download button. Add a Reopen button within that block:
     ```tsx
     {event.status === 'finalized' && (
       <>
         <p className="text-neutral-500">{t('organizer:eventDetail.eventFinalized')}</p>
         <div className="flex flex-col sm:flex-row gap-2">
           <Button
             variant="outline"
             onClick={handleReopen}
             disabled={isUpdating}
           >
             {isUpdating ? (
               <Loader2 className="mr-2 h-4 w-4 animate-spin" />
             ) : null}
             {t('organizer:eventDetail.reopenEvent')}
           </Button>
           <Button
             variant="outline"
             onClick={handleDownload}
             disabled={downloadMutation.isPending}
           >
             {downloadMutation.isPending ? (
               <>
                 <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                 {t('organizer:eventDetail.generating')}
               </>
             ) : (
               <>
                 <Download className="mr-2 h-4 w-4" />
                 {t('organizer:eventDetail.downloadXlsx')}
               </>
             )}
           </Button>
         </div>
       </>
     )}
     ```

  8. Add status controls for the "reopened" status. Below the finalized block, add a new block for reopened:
     ```tsx
     {event.status === 'reopened' && (
       <>
         <p className="text-neutral-500">{t('organizer:eventDetail.eventReopened')}</p>
         <Button
           onClick={() => handleStatusChange('finalized')}
           disabled={isUpdating}
         >
           {isUpdating ? (
             <Loader2 className="mr-2 h-4 w-4 animate-spin" />
           ) : null}
           {t('organizer:eventDetail.refinalizeEvent')}
         </Button>
       </>
     )}
     ```

  9. Add the `handleReopen` function (near `handleStatusChange`):
     ```typescript
     const handleReopen = () => {
       if (!window.confirm(t('organizer:eventDetail.reopenConfirm'))) {
         return
       }
       setStatusErrorDismissed(false)
       updateEvent({ status: 'reopened' })
     }
     ```

  10. Update `handleStatusChange` type signature to also accept 'reopened':
      ```typescript
      const handleStatusChange = (newStatus: 'open' | 'finalized' | 'reopened') => {
      ```

  11. Show QR codes and attendance dashboard for reopened events too. Currently QR codes always show (no status filter). Attendance dashboard shows for non-draft (line 472: `event.status === 'draft'`). This already works for "reopened" since it's not "draft". Verify this — no change needed.
  </action>
  <verify>
  Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.

  Read EventDetailPage.tsx and verify:
  - statusColors includes "reopened" with amber styling
  - Reopen button appears in finalized status block
  - Reopened status block shows "Re-finalize" button
  - CNOV number displays in header when present
  - ParticipantSearch, walk-in button, and ParticipantTable are enabled when status is "reopened"

  Read use-events.ts and verify:
  - PayloadEvent.status includes "reopened"
  - PayloadEvent has cnovDeclarationNumber field

  Read use-participants.ts and verify:
  - useAddWalkIn has onMutate/onError/onSettled for optimistic updates
  </verify>
  <done>
  EventDetailPage shows Reopen button for finalized events, Re-finalize button for reopened events, CNOV display in header, and participant management is re-enabled when event is reopened. Walk-in addition uses optimistic updates for instant feedback. PayloadEvent type includes reopened status and CNOV field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SignPage, DashboardPage, and all i18n translations</name>
  <files>
    frontend/src/pages/SignPage.tsx
    frontend/src/pages/DashboardPage.tsx
    frontend/src/i18n/locales/fr/common.json
    frontend/src/i18n/locales/en/common.json
    frontend/src/i18n/locales/fr/organizer.json
    frontend/src/i18n/locales/en/organizer.json
    frontend/src/i18n/locales/fr/public.json
    frontend/src/i18n/locales/en/public.json
  </files>
  <action>
  **SignPage.tsx changes:**

  1. Update the "event not open" block (line 140). Currently shows blocking message when `eventStatus !== 'open'`. Must also allow "reopened" status. Change from:
     ```tsx
     {eventStatus && eventStatus !== 'open' && (
     ```
     to:
     ```tsx
     {eventStatus && eventStatus !== 'open' && eventStatus !== 'reopened' && (
     ```

  2. Update session selection visibility (line 153). Currently only shows for `eventStatus === 'open'`. Must also show for "reopened":
     ```tsx
     {(eventStatus === 'open' || eventStatus === 'reopened') && sessions.length > 1 && (
     ```

  3. Update participant form visibility (line 184). Currently only shows for `eventStatus === 'open'`. Must also show for "reopened":
     ```tsx
     {(eventStatus === 'open' || eventStatus === 'reopened') && (
     ```

  **DashboardPage.tsx changes:**

  4. Update the `StatusBadge` component (lines 27-37). Currently the status type is `'draft' | 'open' | 'finalized'` and `variants` map has 3 entries. Add "reopened":
     ```typescript
     function StatusBadge({ status }: { status: 'draft' | 'open' | 'finalized' | 'reopened' }) {
       const { t } = useTranslation('common')
       const variants = {
         draft: { variant: 'secondary' as const, label: t('status.draft') },
         open: { variant: 'default' as const, label: t('status.open') },
         finalized: { variant: 'outline' as const, label: t('status.finalized') },
         reopened: { variant: 'default' as const, label: t('status.reopened') },
       }

       const config = variants[status] || variants.draft
       return <Badge variant={config.variant}>{config.label}</Badge>
     }
     ```
     Note: Add fallback `|| variants.draft` for safety in case of unexpected status values.

  **i18n translation changes:**

  5. **frontend/src/i18n/locales/fr/common.json** — Add to the "status" section:
     ```json
     "reopened": "Rouvert"
     ```

  6. **frontend/src/i18n/locales/en/common.json** — Add to the "status" section:
     ```json
     "reopened": "Reopened"
     ```

  7. **frontend/src/i18n/locales/fr/organizer.json** — Add to "eventDetail" section:
     ```json
     "reopenEvent": "Rouvrir l'evenement",
     "reopenConfirm": "Rouvrir cet evenement ? Les participants pourront a nouveau signer.",
     "eventReopened": "Evenement rouvert - les participants peuvent signer",
     "refinalizeEvent": "Finaliser a nouveau",
     "cnov": "CNOV:",
     "walkInSuccess": "Participant ajoute avec succes"
     ```

  8. **frontend/src/i18n/locales/en/organizer.json** — Add to "eventDetail" section:
     ```json
     "reopenEvent": "Reopen event",
     "reopenConfirm": "Reopen this event? Participants will be able to sign again.",
     "eventReopened": "Event reopened - participants can sign",
     "refinalizeEvent": "Finalize again",
     "cnov": "CNOV:",
     "walkInSuccess": "Participant added successfully"
     ```

  9. **frontend/src/i18n/locales/fr/public.json** — Add:
     ```json
     "eventReopened": "Cet evenement a ete rouvert. Vous pouvez signer."
     ```
     Note: This is informational only — the signing form already shows because reopened is treated as open. This string can be used for an optional info banner but is not strictly required.

  10. **frontend/src/i18n/locales/en/public.json** — Add:
      ```json
      "eventReopened": "This event has been reopened. You can sign."
      ```

  **IMPORTANT:** When editing JSON files, ensure valid JSON syntax (correct comma placement, no trailing commas). Each new key-value pair must be properly comma-separated from existing entries.
  </action>
  <verify>
  Run `cd /workspace/frontend && npx tsc --noEmit` to verify TypeScript compiles.

  Read SignPage.tsx and verify:
  - "reopened" status shows signing form (not blocked)
  - Session selection visible for both "open" and "reopened"
  - Participant form visible for both "open" and "reopened"

  Read DashboardPage.tsx and verify:
  - StatusBadge handles "reopened" with correct label and variant

  Verify all 6 i18n JSON files parse correctly:
  ```bash
  for f in frontend/src/i18n/locales/*/common.json frontend/src/i18n/locales/*/organizer.json frontend/src/i18n/locales/*/public.json; do node -e "JSON.parse(require('fs').readFileSync('$f', 'utf8')); console.log('OK: $f')" || echo "FAIL: $f"; done
  ```

  Verify "reopened" key exists in all common.json status sections:
  ```bash
  grep -l '"reopened"' frontend/src/i18n/locales/*/common.json
  ```
  </verify>
  <done>
  SignPage shows signing form for reopened events. DashboardPage StatusBadge displays correct label for reopened status. All 6 i18n files have new translations for reopen flow, CNOV label, and walk-in success. All JSON files are syntactically valid.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd /workspace/frontend && npx tsc --noEmit`
2. All i18n JSON files are valid: parse each with `node -e "JSON.parse(...)"`
3. SignPage treats "reopened" same as "open" for signing form visibility
4. EventDetailPage shows Reopen button for finalized, Re-finalize button for reopened
5. CNOV number visible in event header when populated
6. StatusBadge in DashboardPage handles all 4 statuses
7. Walk-in add uses optimistic updates with rollback
8. All new strings are bilingual (FR + EN)
</verification>

<success_criteria>
- Organizer can reopen finalized event via button click with confirmation
- Reopened event shows Re-finalize button and enables participant management
- Public signing page allows signatures on reopened events
- CNOV number displays on event detail page
- All status labels render correctly in both languages
- Walk-in participant addition provides instant visual feedback
- DashboardPage status badges work for all 4 statuses
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-02-SUMMARY.md`
</output>
