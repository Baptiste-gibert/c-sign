---
phase: 06-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/collections/Events.ts
  - backend/src/collections/Signatures.ts
  - backend/src/hooks/events/afterFinalize.ts
  - backend/src/lib/export/generateXLSX.ts
autonomous: true

must_haves:
  truths:
    - "Backend accepts status transition from finalized to reopened"
    - "Backend accepts status transition from reopened to finalized (re-finalization)"
    - "Backend blocks transition from reopened to draft"
    - "Signatures are accepted on events with status reopened"
    - "Signatures are still blocked on events with status finalized or draft"
    - "Existing signatures are preserved when event is reopened (no deletion)"
    - "CNOV declaration number appears in XLSX export header section"
    - "Re-finalization email sends with updated subject line when event was previously finalized"
  artifacts:
    - path: "backend/src/collections/Events.ts"
      provides: "Extended status options with reopened + updated transition validation"
      contains: "reopened"
    - path: "backend/src/collections/Signatures.ts"
      provides: "Updated signature validation allowing reopened events"
      contains: "reopened"
    - path: "backend/src/hooks/events/afterFinalize.ts"
      provides: "Re-finalization detection and differentiated email handling"
      contains: "reopened"
    - path: "backend/src/lib/export/generateXLSX.ts"
      provides: "CNOV number in XLSX export metadata"
      contains: "cnovDeclarationNumber"
  key_links:
    - from: "backend/src/collections/Events.ts"
      to: "backend/src/collections/Signatures.ts"
      via: "Status field values must match across both hooks"
      pattern: "reopened"
    - from: "backend/src/hooks/events/afterFinalize.ts"
      to: "backend/src/collections/Events.ts"
      via: "afterFinalize checks previousDoc.status for re-finalization detection"
      pattern: "previousDoc.*status.*reopened"
---

<objective>
Extend the backend event lifecycle with controlled reopen capability, update signature validation for reopened events, add CNOV number to XLSX export, and handle re-finalization email differentiation.

Purpose: Enable organizers to reopen finalized events for late participant additions while maintaining data integrity (existing signatures preserved) and compliance exports.
Output: Updated Events and Signatures collections, enhanced XLSX export with CNOV metadata, differentiated re-finalization email handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-RESEARCH.md
@backend/src/collections/Events.ts
@backend/src/collections/Signatures.ts
@backend/src/hooks/events/afterFinalize.ts
@backend/src/lib/export/generateXLSX.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reopened status to Events collection and update Signatures validation</name>
  <files>
    backend/src/collections/Events.ts
    backend/src/collections/Signatures.ts
  </files>
  <action>
  **Events.ts changes:**

  1. Add "reopened" option to the status select field (line 55-59). Insert after "finalized":
     ```typescript
     { label: 'Rouvert', value: 'reopened' },
     ```

  2. Update the beforeChange hook (lines 150-166) to handle new transitions. Replace the existing status validation logic with:
     - `finalized -> reopened`: ALLOWED (this is the controlled reopen)
     - `reopened -> open`: ALLOWED (but not needed — treat reopened as open equivalent)
     - `reopened -> finalized`: ALLOWED (re-finalization after adding late participants)
     - `reopened -> draft`: BLOCKED with error "Un evenement rouvert ne peut pas revenir en brouillon"
     - Keep existing: `open -> draft`: BLOCKED
     - Keep existing: `finalized -> draft`: BLOCKED
     - Keep existing: `finalized -> open`: BLOCKED (must go through reopened)

     The updated hook should be:
     ```typescript
     async ({ data, req, operation, originalDoc }) => {
       if (operation === 'update' && data.status && originalDoc?.status && data.status !== originalDoc.status) {
         const oldStatus = originalDoc.status
         const newStatus = data.status

         // Block: open cannot go back to draft
         if (oldStatus === 'open' && newStatus === 'draft') {
           throw new Error('Un evenement ouvert ne peut pas revenir en brouillon')
         }

         // Allow: finalized -> reopened (controlled reopen)
         if (oldStatus === 'finalized' && newStatus === 'reopened') {
           return data
         }

         // Block: finalized cannot go to anything except reopened
         if (oldStatus === 'finalized') {
           throw new Error('Un evenement finalise ne peut etre que rouvert')
         }

         // Allow: reopened -> finalized (re-finalization)
         if (oldStatus === 'reopened' && newStatus === 'finalized') {
           return data
         }

         // Block: reopened cannot go to draft
         if (oldStatus === 'reopened' && newStatus === 'draft') {
           throw new Error('Un evenement rouvert ne peut pas revenir en brouillon')
         }

         // Block: reopened cannot go to open (treat reopened as equivalent to open)
         if (oldStatus === 'reopened' && newStatus === 'open') {
           throw new Error('Un evenement rouvert est deja ouvert aux signatures')
         }
       }
       return data
     },
     ```

  **Signatures.ts changes:**

  3. Update the beforeChange hook (lines 70-75) that blocks signatures on finalized events. Currently only `event.status === 'finalized'` is checked. The "reopened" status should allow signatures (same as "open"). The hook should:
     - Block signatures when `event.status === 'finalized'` (unchanged)
     - Block signatures when `event.status === 'draft'` (unchanged)
     - Allow signatures when `event.status === 'open'` (unchanged)
     - Allow signatures when `event.status === 'reopened'` (NEW — no additional code needed since only finalized and draft are blocked)

     The existing code already works correctly because it only blocks `finalized` and `draft`. Since `reopened` is neither, signatures will pass through. No code change needed in Signatures.ts for status validation — but verify by reading the hook logic. The hook currently checks: `if (event?.status === 'finalized')` throw, `if (event?.status === 'draft')` throw. Since `reopened` matches neither condition, signatures are allowed. This is correct behavior.

  **IMPORTANT:** Do NOT modify signature data or delete existing signatures when events are reopened. Signatures are independent documents linked by relationships — reopening just allows NEW signatures to be created.
  </action>
  <verify>
  The backend should start successfully with `cd /workspace/backend && npx tsc --noEmit` (TypeScript check).

  Verify by reading Events.ts that:
  - Status options include: draft, open, finalized, reopened
  - beforeChange hook allows finalized -> reopened
  - beforeChange hook allows reopened -> finalized
  - beforeChange hook blocks reopened -> draft
  - beforeChange hook blocks finalized -> open (must go through reopened)

  Verify by reading Signatures.ts that:
  - Only `finalized` and `draft` statuses block signatures
  - No explicit check for `reopened` (it falls through as allowed)
  </verify>
  <done>
  Events collection has "reopened" as a valid status option. Status transitions are correctly validated: finalized->reopened allowed, reopened->finalized allowed, reopened->draft blocked, finalized->open blocked. Signatures are accepted on reopened events.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CNOV to XLSX export and handle re-finalization email</name>
  <files>
    backend/src/lib/export/generateXLSX.ts
    backend/src/hooks/events/afterFinalize.ts
  </files>
  <action>
  **generateXLSX.ts changes:**

  1. Add CNOV declaration number to the XLSX header section. Currently row 1 has event title, row 2 has lieu/organisateur/type. Add CNOV to row 2 metadata if the field has a value. Update the insertRow(2, ...) call to include CNOV:

     ```typescript
     // Build metadata line
     let metadataLine = `Lieu: ${event.location} | Organisateur: ${event.organizerName} | Type: ${event.expenseType}`
     if (event.cnovDeclarationNumber) {
       metadataLine += ` | CNOV: ${event.cnovDeclarationNumber}`
     }
     worksheet.insertRow(2, [metadataLine])
     ```

  **afterFinalize.ts changes:**

  2. Detect re-finalization (when event transitions from `reopened` to `finalized`) vs first finalization (from `open` to `finalized`). The current hook checks `previousDoc?.status !== 'finalized'` which correctly catches both `open -> finalized` AND `reopened -> finalized`.

     Update the email subject line to indicate re-finalization:
     - First finalization: `Feuille de presence - {title}` (existing behavior)
     - Re-finalization: `[Mise a jour] Feuille de presence - {title}`

     Modify the `generateAndEmailExport` function to accept a `isRefinalization` boolean parameter. In the afterFinalize hook, detect it:
     ```typescript
     const isRefinalization = previousDoc?.status === 'reopened'
     ```

     Pass `isRefinalization` to `generateAndEmailExport`. Update the email subject:
     ```typescript
     const subjectPrefix = isRefinalization ? '[Mise a jour] ' : ''
     subject: `${subjectPrefix}Feuille de presence - ${doc.title}`,
     ```

     Also log whether this is a first finalization or re-finalization:
     ```typescript
     console.log(`${isRefinalization ? 'Re-finalizing' : 'Finalizing'} event ${doc.id} (${doc.title})`)
     ```

  **IMPORTANT:** Do NOT add a `finalizedAt` timestamp field — it adds schema complexity that isn't needed. The `previousDoc.status === 'reopened'` check is sufficient for detecting re-finalization.
  </action>
  <verify>
  Verify by reading generateXLSX.ts that:
  - Row 2 metadata includes CNOV declaration number when present
  - Row 2 metadata omits CNOV when field is empty/undefined

  Verify by reading afterFinalize.ts that:
  - Hook detects re-finalization via `previousDoc?.status === 'reopened'`
  - Email subject includes "[Mise a jour]" prefix for re-finalization
  - Email subject is unchanged for first finalization (open -> finalized)

  Run `cd /workspace/backend && npx tsc --noEmit` to confirm no TypeScript errors.
  </verify>
  <done>
  XLSX export includes CNOV declaration number in header metadata. Re-finalization emails have "[Mise a jour]" subject prefix to differentiate from first finalization. Both features handle the absent/empty case gracefully.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd /workspace/backend && npx tsc --noEmit`
2. Events.ts has 4 status options: draft, open, finalized, reopened
3. Status transition validation covers all edge cases (7 transitions: 3 allowed, 4 blocked)
4. Signatures.ts allows signing on reopened events (no explicit block)
5. XLSX export includes CNOV metadata in header
6. afterFinalize hook differentiates first finalization from re-finalization
</verification>

<success_criteria>
- Events collection accepts "reopened" status with correct transition rules
- Signatures can be created on reopened events
- CNOV number appears in XLSX export when populated
- Re-finalization emails have differentiated subject line
- No existing functionality is broken (all prior transitions still work)
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-01-SUMMARY.md`
</output>
