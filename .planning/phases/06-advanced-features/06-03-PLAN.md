---
phase: 06-advanced-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/schemas.ts
  - frontend/src/components/EventForm.tsx
  - frontend/src/pages/EventDetailPage.tsx
  - frontend/src/i18n/locales/fr/organizer.json
  - frontend/src/i18n/locales/en/organizer.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Organizer can enter a CNOV declaration number when creating a new event"
    - "Organizer can edit CNOV declaration number on an existing event from the event detail page"
    - "CNOV field is optional — events can be created without it"
    - "CNOV value set at creation flows through to event detail display and XLSX export"
  artifacts:
    - path: "frontend/src/lib/schemas.ts"
      provides: "cnovDeclarationNumber in createEventSchema"
      contains: "cnovDeclarationNumber"
    - path: "frontend/src/components/EventForm.tsx"
      provides: "CNOV input field in event creation form"
      contains: "cnovDeclarationNumber"
    - path: "frontend/src/pages/EventDetailPage.tsx"
      provides: "Inline CNOV edit capability on event detail"
      contains: "cnovDeclarationNumber"
  key_links:
    - from: "frontend/src/components/EventForm.tsx"
      to: "frontend/src/lib/schemas.ts"
      via: "createEventSchema includes cnovDeclarationNumber"
      pattern: "cnovDeclarationNumber.*optional"
    - from: "frontend/src/components/EventForm.tsx"
      to: "/api/events (POST)"
      via: "form data includes cnovDeclarationNumber field"
      pattern: "cnovDeclarationNumber"
    - from: "frontend/src/pages/EventDetailPage.tsx"
      to: "/api/events/:id (PATCH)"
      via: "useUpdateEvent sends cnovDeclarationNumber"
      pattern: "updateEvent.*cnovDeclarationNumber"
---

<objective>
Add CNOV declaration number input to the event creation form and inline edit capability on the event detail page, closing the gap where organizers cannot set CNOV from the frontend.

Purpose: UAT Test 5 failed because the backend has a cnovDeclarationNumber field on Events but the frontend has no way to set it. This blocks CNOV display (Test 5) and CNOV in XLSX export (Test 7).
Output: Organizers can set CNOV at event creation and edit it from event detail.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-02-SUMMARY.md

@frontend/src/lib/schemas.ts
@frontend/src/components/EventForm.tsx
@frontend/src/pages/EventDetailPage.tsx
@frontend/src/pages/EventCreatePage.tsx
@frontend/src/hooks/use-events.ts
@frontend/src/i18n/locales/fr/organizer.json
@frontend/src/i18n/locales/en/organizer.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CNOV to event creation form and schema</name>
  <files>
    frontend/src/lib/schemas.ts
    frontend/src/components/EventForm.tsx
    frontend/src/i18n/locales/fr/organizer.json
    frontend/src/i18n/locales/en/organizer.json
  </files>
  <action>
    1. In `frontend/src/lib/schemas.ts`, add `cnovDeclarationNumber` to `createEventSchema()` as an optional string field:
       ```
       cnovDeclarationNumber: z.string().optional(),
       ```
       Place it after the `expenseType` field. No validation message needed since it is optional.

    2. In `frontend/src/components/EventForm.tsx`:
       - Add an optional CNOV text input field between the Expense Type select and the Date Selector.
       - Use `{...register('cnovDeclarationNumber')}` (standard register, not Controller — it is a plain text input).
       - Label: `{t('eventForm.cnovDeclarationNumber')}`
       - Placeholder: `{t('eventForm.cnovPlaceholder')}`
       - Add `cnovDeclarationNumber: '',` to `defaultValues` in `useForm`.
       - The field should look identical to the other text inputs (same spacing, Label + Input pattern).

    3. In `frontend/src/i18n/locales/fr/organizer.json`, add to `eventForm` section:
       ```
       "cnovDeclarationNumber": "Numero de declaration CNOV",
       "cnovPlaceholder": "Ex: 2024-12345 (optionnel)"
       ```

    4. In `frontend/src/i18n/locales/en/organizer.json`, add to `eventForm` section:
       ```
       "cnovDeclarationNumber": "CNOV declaration number",
       "cnovPlaceholder": "E.g.: 2024-12345 (optional)"
       ```
  </action>
  <verify>
    Run `cd /workspace/frontend && npx tsc --noEmit` — no TypeScript errors.
    Verify `cnovDeclarationNumber` appears in schemas.ts createEventSchema.
    Verify EventForm.tsx has the CNOV input field with register('cnovDeclarationNumber').
    Verify both organizer.json files have the new translation keys.
  </verify>
  <done>
    Event creation form includes an optional CNOV declaration number text input. The field value flows through the schema and form submission to the POST /api/events endpoint. Both FR and EN translations exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline CNOV edit on EventDetailPage</name>
  <files>
    frontend/src/pages/EventDetailPage.tsx
    frontend/src/i18n/locales/fr/organizer.json
    frontend/src/i18n/locales/en/organizer.json
  </files>
  <action>
    1. In `frontend/src/pages/EventDetailPage.tsx`, add an inline editable CNOV field in the event header area, near where CNOV is currently displayed (lines 196-201).

       Replace the existing read-only CNOV display with an editable pattern:
       - Add state: `const [editingCnov, setEditingCnov] = useState(false)` and `const [cnovValue, setCnovValue] = useState(event.cnovDeclarationNumber || '')`.
       - Add a `useEffect` to sync `cnovValue` when event data changes: `useEffect(() => setCnovValue(event.cnovDeclarationNumber || ''), [event.cnovDeclarationNumber])`.
       - Import `Pencil` from lucide-react (add to existing import).

       When NOT editing (default view):
       - If CNOV exists: show `CNOV: {value}` with a small pencil icon button next to it that sets `setEditingCnov(true)`. Only show the edit button when event is not locked (use `!isLocked`).
       - If CNOV does not exist and event is not locked: show a small "Add CNOV" link/button that sets `setEditingCnov(true)`.
       - If CNOV does not exist and event is locked: show nothing (current behavior).

       When editing:
       - Show a compact inline form: `<Input>` (small, ~200px) + Save button + Cancel button.
       - Save calls `updateEvent({ cnovDeclarationNumber: cnovValue })` then `setEditingCnov(false)`.
       - Cancel resets `cnovValue` to `event.cnovDeclarationNumber || ''` and sets `setEditingCnov(false)`.
       - Place this editing UI in a new row below the header metadata, not inline in the badges row (to avoid layout disruption).

    2. Add translation keys to both organizer.json files:

       French (`fr/organizer.json`) in `eventDetail` section:
       ```
       "addCnov": "Ajouter CNOV",
       "editCnov": "Modifier",
       "saveCnov": "Enregistrer",
       "cancelCnov": "Annuler"
       ```

       English (`en/organizer.json`) in `eventDetail` section:
       ```
       "addCnov": "Add CNOV",
       "editCnov": "Edit",
       "saveCnov": "Save",
       "cancelCnov": "Cancel"
       ```

    Note: The `useUpdateEvent` hook already exists and supports PATCH with any event fields including `cnovDeclarationNumber`. No hook changes needed.
  </action>
  <verify>
    Run `cd /workspace/frontend && npx tsc --noEmit` — no TypeScript errors.
    Verify EventDetailPage.tsx has editingCnov state, pencil icon import, inline edit form.
    Verify both organizer.json files have addCnov, editCnov, saveCnov, cancelCnov keys.
    Validate JSON syntax: `node -e "JSON.parse(require('fs').readFileSync('frontend/src/i18n/locales/fr/organizer.json'))"` and same for en.
  </verify>
  <done>
    Organizer can see, add, and edit the CNOV declaration number directly from the event detail page. When no CNOV is set and event is not locked, an "Add CNOV" button appears. When CNOV exists, it displays with an edit pencil. Clicking either opens an inline input for editing. Save persists via PATCH API. Edit controls hidden when event is finalized (locked).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `cd /workspace/frontend && npx tsc --noEmit`
2. All i18n JSON files are valid JSON
3. EventForm.tsx includes cnovDeclarationNumber input with register()
4. schemas.ts createEventSchema includes cnovDeclarationNumber as optional string
5. EventDetailPage.tsx has inline CNOV editing with save/cancel
6. CNOV edit controls hidden when event is locked (finalized)
</verification>

<success_criteria>
- Organizer can enter CNOV declaration number when creating a new event (optional field)
- Organizer can add/edit CNOV on event detail page via inline edit
- CNOV flows through to display and XLSX export (existing backend support)
- All strings bilingual (FR/EN)
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-03-SUMMARY.md`
</output>
